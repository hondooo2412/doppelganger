<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Doppelganger</title>
<link rel="stylesheet" href="css/common.css">
<style>
  .auth-page{
    min-height:100vh;min-height:100dvh;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    padding:20px;
    padding-bottom:40px;
  }
  .auth-logo{
    font-size:clamp(2rem,7vw,3rem);font-weight:900;letter-spacing:-.03em;
    background:linear-gradient(135deg,#6c5ce7,#a29bfe,#fd79a8,#e84393);
    background-size:200% 200%;
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    animation:float 4s ease-in-out infinite;
    margin-bottom:4px;text-align:center;
  }
  .auth-logo-sub{
    font-size:.72rem;letter-spacing:.3em;color:var(--text2);
    text-transform:uppercase;text-align:center;margin-bottom:32px;
  }
  .auth-card{
    width:100%;max-width:400px;
    background:var(--surface);border:1px solid var(--surface3);
    border-radius:var(--radius);padding:28px 24px;
    box-shadow:var(--shadow);animation:fadeIn .6s ease;
  }
  .auth-tabs{
    display:flex;gap:0;margin-bottom:24px;
    border-bottom:1px solid var(--surface3);
  }
  .auth-tab{
    flex:1;padding:10px;text-align:center;
    font-size:.88rem;font-weight:600;
    color:var(--text2);background:none;border:none;
    border-bottom:2px solid transparent;
    cursor:pointer;transition:all .2s;
  }
  .auth-tab.active{color:var(--accent2);border-bottom-color:var(--accent)}
  .auth-tab:hover:not(.active){color:var(--text)}
  .auth-form{display:none}
  .auth-form.active{display:block}
  .auth-divider{
    display:flex;align-items:center;gap:12px;
    margin:20px 0;color:var(--text2);font-size:.75rem;
  }
  .auth-divider::before,.auth-divider::after{
    content:'';flex:1;height:1px;background:var(--surface3);
  }
  .google-btn{
    width:100%;padding:12px;
    background:var(--surface2);border:1px solid var(--surface3);
    border-radius:10px;color:var(--text);
    font-size:.85rem;font-weight:500;
    cursor:pointer;transition:all .2s;
    display:flex;align-items:center;justify-content:center;gap:8px;
  }
  .google-btn:hover{border-color:var(--accent);background:var(--surface3)}
  .google-btn svg{width:18px;height:18px}
  .auth-footer{
    text-align:center;margin-top:20px;
    font-size:.78rem;color:var(--text2);
  }
  .auth-footer a{color:var(--accent2)}
  .forgot-link{
    display:block;text-align:right;
    font-size:.75rem;color:var(--text2);
    margin-top:8px;cursor:pointer;
  }
  .forgot-link:hover{color:var(--accent2)}
  .auth-status{
    text-align:center;font-size:.82rem;
    margin-top:12px;min-height:1.2em;
  }
  .auth-status.error{color:var(--danger)}
  .auth-status.success{color:var(--success)}
  .auth-intro{
    text-align:center;max-width:400px;
    margin-bottom:28px;animation:fadeIn .8s ease;
  }
  .auth-intro p{font-size:.85rem;color:var(--text2);line-height:1.7}
</style>
</head>
<body>

<div class="auth-page" id="auth-page">
  <div class="auth-logo">Doppelganger</div>
  <div class="auth-logo-sub">find your true self</div>

  <div class="auth-intro">
    <p>136の問いがあなたの精神構造を解き明かす。<br>
    同じ魂を持つ者たちが集う掲示板へ。</p>
  </div>

  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" data-tab="login">ログイン</button>
      <button class="auth-tab" data-tab="signup">新規登録</button>
    </div>

    <!-- ログインフォーム -->
    <form class="auth-form active" id="login-form">
      <div class="form-group">
        <label class="form-label">メールアドレス</label>
        <input type="email" class="form-input" id="login-email"
               placeholder="email@example.com" required autocomplete="email">
      </div>
      <div class="form-group">
        <label class="form-label">パスワード</label>
        <input type="password" class="form-input" id="login-password"
               placeholder="パスワード" required autocomplete="current-password">
        <span class="forgot-link" id="forgot-link">パスワードを忘れた方</span>
      </div>
      <button type="submit" class="btn btn-primary btn-block" id="login-btn">
        ログイン
      </button>
      <div class="auth-status" id="login-status"></div>
    </form>

    <!-- 新規登録フォーム -->
    <form class="auth-form" id="signup-form">
      <div class="form-group">
        <label class="form-label">メールアドレス</label>
        <input type="email" class="form-input" id="signup-email"
               placeholder="email@example.com" required autocomplete="email">
      </div>
      <div class="form-group">
        <label class="form-label">パスワード</label>
        <input type="password" class="form-input" id="signup-password"
               placeholder="8文字以上" required minlength="8" autocomplete="new-password">
        <div class="form-hint">8文字以上の英数字</div>
      </div>
      <div class="form-group">
        <label class="form-label">パスワード（確認）</label>
        <input type="password" class="form-input" id="signup-password-confirm"
               placeholder="もう一度入力" required minlength="8" autocomplete="new-password">
      </div>
      <button type="submit" class="btn btn-primary btn-block" id="signup-btn">
        アカウント作成
      </button>
      <div class="auth-status" id="signup-status"></div>
    </form>

    <div class="auth-divider">または</div>

    <button class="google-btn" id="google-btn">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/>
        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
      </svg>
      Googleでログイン
    </button>

    <div class="auth-footer mt-16">
      アカウント作成により<a href="docs/legal-checklist.md">利用規約</a>に同意したものとみなされます
    </div>
  </div>
</div>

<!-- パスワードリセットモーダル -->
<div class="modal-overlay" id="reset-modal">
  <div class="modal">
    <div class="modal-title">パスワードリセット</div>
    <p class="text-sm text-muted mb-16">登録済みのメールアドレスを入力してください。パスワードリセット用のリンクをお送りします。</p>
    <div class="form-group">
      <input type="email" class="form-input" id="reset-email" placeholder="email@example.com">
    </div>
    <div class="auth-status" id="reset-status"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary btn-sm" id="reset-cancel">キャンセル</button>
      <button class="btn btn-primary btn-sm" id="reset-submit">送信</button>
    </div>
  </div>
</div>

<!-- Supabase SDK (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="js/supabase-config.js"></script>
<script src="js/auth.js"></script>
<script>
(function() {
  // --- タブ切り替え ---
  const tabs = document.querySelectorAll('.auth-tab');
  const forms = document.querySelectorAll('.auth-form');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      forms.forEach(f => f.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab + '-form').classList.add('active');
    });
  });

  // --- ログイン ---
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const status = document.getElementById('login-status');
    const btn = document.getElementById('login-btn');
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;

    status.className = 'auth-status';
    status.textContent = '';
    btn.disabled = true;
    btn.textContent = 'ログイン中...';

    try {
      await Auth.signIn(email, password);
      status.className = 'auth-status success';
      status.textContent = 'ログイン成功！リダイレクト中...';
      // 診断済みか確認して遷移先を決定
      const profile = await getMyProfile(true);
      if (profile && profile.diagnosis_completed_at) {
        window.location.href = 'board.html';
      } else {
        window.location.href = 'doppelganger-diagnosis.index.html';
      }
    } catch (err) {
      status.className = 'auth-status error';
      status.textContent = translateAuthError(err.message);
      btn.disabled = false;
      btn.textContent = 'ログイン';
    }
  });

  // --- 新規登録 ---
  document.getElementById('signup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const status = document.getElementById('signup-status');
    const btn = document.getElementById('signup-btn');
    const email = document.getElementById('signup-email').value.trim();
    const password = document.getElementById('signup-password').value;
    const confirm = document.getElementById('signup-password-confirm').value;

    status.className = 'auth-status';
    status.textContent = '';

    if (password !== confirm) {
      status.className = 'auth-status error';
      status.textContent = 'パスワードが一致しません';
      return;
    }

    btn.disabled = true;
    btn.textContent = '作成中...';

    try {
      await Auth.signUp(email, password);
      status.className = 'auth-status success';
      status.textContent = '確認メールを送信しました。メールのリンクをクリックしてください。';
    } catch (err) {
      status.className = 'auth-status error';
      status.textContent = translateAuthError(err.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'アカウント作成';
    }
  });

  // --- Googleログイン ---
  document.getElementById('google-btn').addEventListener('click', async () => {
    try {
      await Auth.signInWithGoogle();
    } catch (err) {
      showToast('Googleログインに失敗しました', 'error');
    }
  });

  // --- パスワードリセット ---
  document.getElementById('forgot-link').addEventListener('click', () => {
    document.getElementById('reset-modal').classList.add('show');
    document.getElementById('reset-email').value = document.getElementById('login-email').value;
  });
  document.getElementById('reset-cancel').addEventListener('click', () => {
    document.getElementById('reset-modal').classList.remove('show');
  });
  document.getElementById('reset-modal').addEventListener('click', (e) => {
    if (e.target.id === 'reset-modal') {
      document.getElementById('reset-modal').classList.remove('show');
    }
  });
  document.getElementById('reset-submit').addEventListener('click', async () => {
    const email = document.getElementById('reset-email').value.trim();
    const status = document.getElementById('reset-status');
    if (!email) {
      status.className = 'auth-status error';
      status.textContent = 'メールアドレスを入力してください';
      return;
    }
    try {
      await Auth.resetPassword(email);
      status.className = 'auth-status success';
      status.textContent = 'リセットメールを送信しました';
    } catch (err) {
      status.className = 'auth-status error';
      status.textContent = translateAuthError(err.message);
    }
  });

  // --- 認証エラーの日本語化 ---
  function translateAuthError(msg) {
    const map = {
      'Invalid login credentials': 'メールアドレスまたはパスワードが正しくありません',
      'Email not confirmed': 'メールアドレスが未確認です。確認メールをご確認ください',
      'User already registered': 'このメールアドレスは既に登録されています',
      'Password should be at least 6 characters': 'パスワードは6文字以上にしてください',
      'Signup requires a valid password': '有効なパスワードを入力してください',
      'Unable to validate email address: invalid format': 'メールアドレスの形式が正しくありません',
    };
    return map[msg] || msg || '予期しないエラーが発生しました';
  }

  // --- 初期化: 既にログイン済みならリダイレクト ---
  Auth.initAuthUI();
})();
</script>
</body>
</html>
