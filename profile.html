<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Doppelganger - ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
<link rel="stylesheet" href="css/common.css">
<style>
  .profile-card{
    background:linear-gradient(145deg,var(--surface),var(--surface2));
    border:1px solid var(--surface3);
    border-radius:20px;padding:28px 24px;
    box-shadow:var(--shadow);text-align:center;
    margin-bottom:16px;animation:fadeIn .5s ease;
  }
  .profile-icon{
    width:80px;height:80px;border-radius:50%;
    margin:0 auto 14px;
    display:flex;align-items:center;justify-content:center;
    font-size:2.2rem;animation:float 4s ease-in-out infinite;
    overflow:hidden;
  }
  .profile-icon img{width:100%;height:100%;object-fit:cover}
  .profile-nickname{
    font-size:1.2rem;font-weight:800;
    color:var(--text);margin-bottom:2px;
  }
  .profile-type-name{
    font-size:.95rem;font-weight:700;
    background:linear-gradient(135deg,var(--accent),var(--accent2),var(--pink));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    margin-bottom:4px;
  }
  .profile-type-sub{font-size:.82rem;color:var(--text2);margin-bottom:8px}
  .profile-bio{
    font-size:.82rem;color:var(--text2);line-height:1.6;
    padding:8px 12px;background:var(--surface);border-radius:8px;
    margin:8px 0;
  }
  .profile-display-id{
    display:inline-block;
    padding:4px 14px;border-radius:20px;
    background:var(--surface);border:1px solid var(--surface3);
    font-size:.78rem;color:var(--text2);font-weight:600;
    letter-spacing:.05em;
  }

  .profile-stats{
    display:grid;grid-template-columns:1fr 1fr;gap:8px;
    margin:16px 0;
  }
  .stat-item{
    background:var(--surface);border:1px solid var(--surface3);
    border-radius:var(--radius);padding:14px;text-align:center;
  }
  .stat-value{font-size:1.2rem;font-weight:700;color:var(--accent2)}
  .stat-label{font-size:.7rem;color:var(--text2);margin-top:4px}

  .profile-section{margin-bottom:16px}
  .profile-section .section-title{margin-bottom:8px}

  .menu-item{
    display:flex;align-items:center;gap:12px;
    padding:14px 16px;
    background:var(--surface);border:1px solid var(--surface3);
    border-radius:var(--radius);margin-bottom:8px;
    cursor:pointer;transition:all .2s;
    text-decoration:none;color:var(--text);
  }
  .menu-item:hover{border-color:rgba(108,92,231,.3);transform:translateX(4px)}
  .menu-icon{font-size:1.2rem;flex-shrink:0;width:32px;text-align:center}
  .menu-label{flex:1;font-size:.88rem;font-weight:500}
  .menu-arrow{color:var(--text2);font-size:.9rem}

  .logout-btn{
    width:100%;padding:14px;margin-top:24px;
    background:transparent;border:1px solid rgba(225,112,85,.3);
    border-radius:var(--radius);color:var(--danger);
    font-size:.88rem;font-weight:600;cursor:pointer;
    transition:all .2s;
  }
  .logout-btn:hover{background:rgba(225,112,85,.06);border-color:var(--danger)}

  .diagnosis-scores{
    display:grid;grid-template-columns:1fr 1fr;gap:6px;
    margin-top:8px;
  }
  .score-item{
    display:flex;justify-content:space-between;align-items:center;
    padding:6px 10px;background:var(--surface2);border-radius:8px;
    font-size:.75rem;
  }
  .score-name{color:var(--text2)}
  .score-value{color:var(--accent2);font-weight:600}

  .scores-toggle{
    display:block;margin:8px auto 0;
    padding:6px 16px;border:1px solid var(--surface3);
    border-radius:50px;background:transparent;color:var(--text2);
    font-size:.75rem;cursor:pointer;transition:all .2s;
  }
  .scores-toggle:hover{border-color:var(--accent);color:var(--text)}

  .edit-profile-btn{
    margin-top:12px;
    padding:8px 20px;
    font-size:.8rem;font-weight:600;
    background:var(--surface);border:1px solid var(--surface3);
    border-radius:50px;color:var(--text2);
    cursor:pointer;transition:all .2s;
  }
  .edit-profile-btn:hover{border-color:var(--accent);color:var(--text)}

  /* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDå…¥åŠ› */
  .username-input-wrap{
    display:flex;align-items:center;gap:0;
  }
  .username-at{
    padding:0 10px;height:44px;line-height:44px;
    background:var(--surface2);border:1px solid var(--surface3);
    border-right:none;border-radius:var(--radius) 0 0 var(--radius);
    color:var(--text2);font-size:.95rem;font-weight:600;flex-shrink:0;
  }
  .username-input-wrap .form-input{
    border-radius:0 var(--radius) var(--radius) 0;
  }

  /* è¨ºæ–­å±¥æ­´ */
  .history-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .history-item{
    display:flex;align-items:center;gap:12px;
    padding:12px 14px;
    background:var(--surface);border:1px solid var(--surface3);
    border-radius:var(--radius);
  }
  .history-num{
    font-size:.72rem;color:var(--text2);
    background:var(--surface2);padding:2px 7px;border-radius:20px;
    flex-shrink:0;
  }
  .history-type{
    flex:1;
  }
  .history-type-name{font-size:.88rem;font-weight:700;color:var(--text)}
  .history-type-sub{font-size:.72rem;color:var(--text2);margin-top:1px}
  .history-date{font-size:.7rem;color:var(--text2);flex-shrink:0}

  /* è¶£å‘³é¸æŠ */
  .hobby-section-label{
    font-size:.78rem;color:var(--text2);margin-bottom:10px;line-height:1.6;
  }
  .hobby-grid{
    display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));
    gap:8px;
  }
  .hobby-chip{
    display:flex;align-items:center;gap:6px;
    padding:9px 12px;
    background:var(--surface);border:1.5px solid var(--surface3);
    border-radius:10px;cursor:pointer;transition:all .2s;
    font-size:.8rem;user-select:none;
  }
  .hobby-chip:hover{border-color:rgba(108,92,231,.4)}
  .hobby-chip.selected{
    border-color:var(--accent);
    background:rgba(108,92,231,.1);
    color:var(--accent2);font-weight:600;
  }
  .hobby-chip.disabled{
    opacity:.35;cursor:not-allowed;
  }
  .hobby-chip-icon{font-size:1.1rem;flex-shrink:0}
  .hobby-limit-hint{
    font-size:.72rem;color:var(--text2);margin-top:8px;text-align:right;
  }
  .hobby-limit-hint.over{color:var(--danger)}
</style>
</head>
<body>

<div class="page" id="page">
  <div class="container">

    <!-- åˆå›è¨­å®šã‚¦ã‚§ãƒ«ã‚«ãƒ ï¼ˆ?setup=1 ã®æ™‚ã ã‘è¡¨ç¤ºï¼‰ -->
    <div id="setup-welcome" style="display:none">
      <div class="profile-setup-welcome">
        <div class="welcome-emoji">ğŸ‘‹</div>
        <div class="welcome-title">ã‚ˆã†ã“ãï¼</div>
        <div class="welcome-desc">
          ã¾ãšã€ã‚ãªãŸã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚<br>
          ãã®å¾Œã€æ€§æ ¼è¨ºæ–­ã¸ã¨é€²ã¿ã¾ã™ã€‚
        </div>
      </div>
    </div>

    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="profile-edit" style="display:none">
      <div class="profile-edit-section">
        <div class="profile-edit-title" id="edit-title">âœï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</div>

        <!-- ã‚¢ãƒã‚¿ãƒ¼ -->
        <div class="avatar-upload-area">
          <div class="avatar-preview" id="avatar-preview" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ">
            <span id="avatar-preview-content">ğŸ‘¤</span>
            <div class="avatar-overlay">ğŸ“· å¤‰æ›´</div>
          </div>
          <input type="file" id="avatar-input" accept="image/*" style="display:none">
          <div class="avatar-upload-info">
            <div class="upload-label">ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒ</div>
            <div class="upload-hint">æ­£æ–¹å½¢ã«ã‚¯ãƒ­ãƒƒãƒ—ã•ã‚Œã¾ã™<br>200Ã—200px / WebPå¤‰æ› / 50KBä»¥ä¸‹</div>
            <button class="avatar-upload-btn" id="avatar-upload-btn">ğŸ“· ç”»åƒã‚’é¸æŠ</button>
            <button class="avatar-remove-btn" id="avatar-remove-btn" style="display:none">ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤</button>
          </div>
        </div>

        <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDï¼ˆåˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ã®ã¿è¡¨ç¤ºã€å¤‰æ›´ä¸å¯ï¼‰ -->
        <div class="form-group" id="username-form-group" style="display:none">
          <label class="form-label">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDï¼ˆå¿…é ˆãƒ»å¤‰æ›´ä¸å¯ï¼‰</label>
          <div class="username-input-wrap">
            <span class="username-at">@</span>
            <input type="text" class="form-input" id="username-input" maxlength="20"
                   placeholder="åŠè§’è‹±æ•°å­—ãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿"
                   pattern="[a-zA-Z0-9_]+" autocomplete="username">
          </div>
          <div class="form-hint">ä¾‹: tanaka_taroï½œä¸€åº¦è¨­å®šã—ãŸã‚‰å¤‰æ›´ã§ãã¾ã›ã‚“</div>
          <div class="form-error" id="username-error">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        </div>

        <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  -->
        <div class="form-group">
          <label class="form-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆå¿…é ˆï¼‰</label>
          <input type="text" class="form-input" id="nickname-input" maxlength="20" placeholder="ã¿ã‚“ãªã«è¡¨ç¤ºã•ã‚Œã‚‹åå‰ï¼ˆå¾Œã‹ã‚‰å¤‰æ›´å¯ï¼‰">
          <div class="char-count"><span id="nickname-count">0</span>/20</div>
          <div class="form-error" id="nickname-error">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        </div>

        <!-- è‡ªå·±ç´¹ä»‹ -->
        <div class="form-group">
          <label class="form-label">è‡ªå·±ç´¹ä»‹ï¼ˆä»»æ„ï¼‰</label>
          <textarea class="form-input" id="bio-input" maxlength="100" placeholder="è¶£å‘³ã‚„å¥½ããªã“ã¨ãªã©..." rows="3"></textarea>
          <div class="char-count"><span id="bio-count">0</span>/100</div>
        </div>

        <!-- è¶£å‘³é¸æŠ -->
        <div class="form-group" id="hobby-form-group">
          <label class="form-label">å¥½ããªã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆæœ€å¤§3ã¤ï¼‰</label>
          <div class="hobby-section-label">
            æ²ç¤ºæ¿ã®TOPã«ã€é¸ã‚“ã ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒå„ªå…ˆè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </div>
          <div class="hobby-grid" id="hobby-grid"></div>
          <div class="hobby-limit-hint" id="hobby-limit-hint">0 / 3 é¸æŠ</div>
        </div>

        <button class="btn btn-primary btn-block" id="save-profile-btn">ä¿å­˜ã™ã‚‹</button>
        <button class="btn btn-secondary btn-block btn-sm mt-8" id="cancel-edit-btn" style="display:none">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>

    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ï¼ˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
    <div class="profile-card" id="profile-card">
      <div class="loading"><div class="spinner"></div></div>
    </div>

    <!-- çµ±è¨ˆ -->
    <div class="profile-stats" id="profile-stats"></div>

    <!-- è¨ºæ–­å±¥æ­´ -->
    <div class="profile-section" id="history-section" style="display:none">
      <div class="section-title">è¨ºæ–­å±¥æ­´ï¼ˆç›´è¿‘3å›ï¼‰</div>
      <div class="card">
        <div class="history-list" id="history-list"></div>
      </div>
    </div>

    <!-- På¤‰æ•°ã‚¹ã‚³ã‚¢ -->
    <div class="profile-section" id="scores-section" style="display:none">
      <div class="section-title">è¨ºæ–­ã‚¹ã‚³ã‚¢ï¼ˆéå…¬é–‹ï¼‰</div>
      <div class="card">
        <div class="diagnosis-scores" id="diagnosis-scores"></div>
        <button class="scores-toggle" id="scores-toggle">ã‚‚ã£ã¨è¦‹ã‚‹ â–¼</button>
      </div>
    </div>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="profile-section" id="menu-section">
      <div class="section-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>

      <a href="doppelganger-diagnosis.index.html" class="menu-item">
        <span class="menu-icon">ğŸ”®</span>
        <span class="menu-label">è¨ºæ–­ã‚’ã‚„ã‚Šç›´ã™</span>
        <span class="menu-arrow">â€º</span>
      </a>

      <a href="board.html" class="menu-item">
        <span class="menu-icon">ğŸ’¬</span>
        <span class="menu-label">æ²ç¤ºæ¿ã¸</span>
        <span class="menu-arrow">â€º</span>
      </a>

      <div class="menu-item" id="edit-hobby-btn">
        <span class="menu-icon">ğŸŒŸ</span>
        <span class="menu-label">è¶£å‘³ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¨­å®š</span>
        <span class="menu-arrow">â€º</span>
      </div>

      <div class="menu-item" id="share-btn">
        <span class="menu-icon">ğŸ“¤</span>
        <span class="menu-label">è¨ºæ–­çµæœã‚’ã‚·ã‚§ã‚¢</span>
        <span class="menu-arrow">â€º</span>
      </div>
    </div>

    <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ -->
    <button class="logout-btn" id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

    <div class="text-center mt-16 text-xs text-muted">
      Doppelganger v1.0
    </div>
  </div>
</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<nav class="nav-bar">
  <a href="board.html" class="nav-item">
    <span class="nav-icon">ğŸ’¬</span>
    <span>æ²ç¤ºæ¿</span>
  </a>
  <a href="matching.html" class="nav-item">
    <span class="nav-icon">ğŸ’•</span>
    <span>ãƒãƒƒãƒãƒ³ã‚°</span>
  </a>
  <a href="profile.html" class="nav-item active">
    <span class="nav-icon" id="nav-my-avatar">ğŸ‘¤</span>
    <span id="nav-my-name">ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
  </a>
</nav>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="js/supabase-config.js"></script>
<script src="js/auth.js"></script>
<script src="js/avatar.js"></script>
<script>
(function() {
  const P_NAMES = {
    P1:'ç¤¾ä¼šä¹–é›¢å€¤',P2:'åˆç†æ€§',P3:'å¯¾äººè·é›¢',P4:'ä¸»å¾“',
    P5:'è–åŸŸ',P6:'å­¤é«˜åº¦',P7:'è¦šé†’å‹•æ©Ÿ',P8:'æƒ…ç·’å¤‰å‹•æ€§',
    P9:'ç§©åºæ€§',P10:'æ¢ç´¢æ¬²',P11:'æ„Ÿæƒ…éœ²å‡ºåº¦',P12:'ä¾å­˜æ§‹é€ ',
    P13:'å¯¾è©±æ§‹é€ ',P14:'æ„›ç€è¡¨ç¾',P15:'è‘›è—¤å¯¾å‡¦',
  };

  const HOBBY_CATEGORIES = [
    { id:  1, name: 'é›‘è«‡ãƒ»æ—¥å¸¸',             icon: 'ğŸ’¬' },
    { id:  2, name: 'éŸ³æ¥½',                  icon: 'ğŸµ' },
    { id:  3, name: 'ã‚¢ãƒ‹ãƒ¡ãƒ»ãƒãƒ³ã‚¬ãƒ»ã‚²ãƒ¼ãƒ ', icon: 'ğŸ®' },
    { id:  4, name: 'æ˜ ç”»ãƒ»ãƒ‰ãƒ©ãƒãƒ»å‹•ç”»',     icon: 'ğŸ¬' },
    { id:  5, name: 'ã‚¹ãƒãƒ¼ãƒ„ãƒ»ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢',   icon: 'âš½' },
    { id:  6, name: 'èª­æ›¸ãƒ»å­¦ç¿’',             icon: 'ğŸ“š' },
    { id:  7, name: 'å‰µä½œãƒ»ã‚¢ãƒ¼ãƒˆ',           icon: 'ğŸ¨' },
    { id:  8, name: 'ã‚°ãƒ«ãƒ¡ãƒ»é£Ÿ',             icon: 'ğŸœ' },
    { id:  9, name: 'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ãƒ»ç¾å®¹',     icon: 'ğŸ‘—' },
    { id: 10, name: 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼',           icon: 'ğŸ’»' },
    { id: 11, name: 'ã‚ªãƒ•ä¼šãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ',       icon: 'ğŸ‰' },
    { id: 12, name: 'ãŠæ‚©ã¿ãƒ»ã‚µãƒãƒ¼ãƒˆ',       icon: 'ğŸ¤' },
    { id: 13, name: 'Doppelganger',          icon: 'ğŸ”®' },
  ];

  const params = new URLSearchParams(window.location.search);
  let isSetupMode = params.get('setup') === '1';
  let isHobbyTab  = params.get('tab') === 'hobby';
  let currentProfile = null;
  let pendingAvatarBlob = null; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾…ã¡ã®blob
  let selectedHobbies  = [];    // é¸æŠä¸­ã®å¤§ã‚«ãƒ†ã‚´ãƒªãƒ¼IDãƒªã‚¹ãƒˆ

  async function init() {
    try {
      const user = await requireAuth();
      if (!user) return;

      currentProfile = await getMyProfile(true);
      if (!currentProfile) {
        window.location.href = 'index.html';
        return;
      }

      // è¶£å‘³ã‚¿ãƒ–ç›´ã‚¢ã‚¯ã‚»ã‚¹ or ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ã®åˆ¤å®š
      if (isHobbyTab) {
        showEditMode(false);
        setTimeout(() => {
          document.getElementById('hobby-form-group')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 200);
      } else if (isSetupMode || !currentProfile.nickname) {
        showEditMode(true);
      } else {
        showViewMode();
      }

      initNavUser();
    } catch (err) {
      showToast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  }

  // --- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ ---
  function showViewMode() {
    document.getElementById('profile-edit').style.display = 'none';
    document.getElementById('setup-welcome').style.display = 'none';
    document.getElementById('profile-card').style.display = 'block';
    document.getElementById('menu-section').style.display = 'block';

    renderProfile(currentProfile);
    loadStats(currentProfile.id);
  }

  // --- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ ---
  function showEditMode(isFirstTime) {
    document.getElementById('profile-edit').style.display = 'block';
    document.getElementById('profile-card').style.display = 'none';
    document.getElementById('history-section').style.display = 'none';
    document.getElementById('scores-section').style.display = 'none';

    if (isFirstTime && !currentProfile.nickname) {
      document.getElementById('setup-welcome').style.display = 'block';
      document.getElementById('edit-title').textContent = 'ğŸ¨ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š';
      document.getElementById('cancel-edit-btn').style.display = 'none';
      document.getElementById('menu-section').style.display = 'none';
      // usernameãŒã¾ã æœªè¨­å®šãªã‚‰å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
      if (!currentProfile.username) {
        document.getElementById('username-form-group').style.display = 'block';
      }
    } else {
      document.getElementById('setup-welcome').style.display = 'none';
      document.getElementById('edit-title').textContent = 'âœï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†';
      document.getElementById('cancel-edit-btn').style.display = 'block';
      // æ—¢ã«usernameãŒè¨­å®šã•ã‚Œã¦ã„ãŸã‚‰éè¡¨ç¤ºï¼ˆå¤‰æ›´ä¸å¯ï¼‰
      document.getElementById('username-form-group').style.display = 'none';
    }

    // æ—¢å­˜å€¤ã‚’ãƒ—ãƒªãƒ•ã‚£ãƒ«
    const nicknameInput = document.getElementById('nickname-input');
    const bioInput = document.getElementById('bio-input');
    nicknameInput.value = currentProfile.nickname || '';
    bioInput.value = currentProfile.bio || '';
    updateCharCount('nickname');
    updateCharCount('bio');

    // è¶£å‘³ã‚°ãƒªãƒƒãƒ‰ã‚’åˆæœŸåŒ–
    selectedHobbies = Array.isArray(currentProfile.hobbies) ? [...currentProfile.hobbies] : [];
    renderHobbyGrid();

    // ã‚¢ãƒã‚¿ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    updateAvatarPreview();
  }

  function renderProfile(profile) {
    const fam = profile.family || '';
    const famRGB = _familyColorRGB(fam);
    const badgeClass = fam ? `badge-${fam.toLowerCase()}` : '';

    // ã‚¢ãƒã‚¿ãƒ¼è¡¨ç¤º
    let avatarHtml;
    if (profile.avatar_url) {
      avatarHtml = `<img src="${escapeHtml(profile.avatar_url)}" alt="">`;
    } else {
      avatarHtml = getTypeEmoji(profile.type_number);
    }

    document.getElementById('profile-card').innerHTML = `
      <div class="profile-icon" style="background:rgba(${famRGB},.12);border:2px solid rgba(${famRGB},.3)">
        ${avatarHtml}
      </div>
      ${profile.nickname ? `<div class="profile-nickname">${escapeHtml(profile.nickname)}</div>` : ''}
      ${profile.username ? `<div style="font-size:.78rem;color:var(--text2);margin-bottom:4px">@${escapeHtml(profile.username)}</div>` : ''}
      <div class="profile-type-name">Type ${profile.type_number || '?'}: ${escapeHtml(profile.type_name || 'æœªè¨ºæ–­')}</div>
      <div class="profile-type-sub">
        <span class="badge ${badgeClass}">${fam || 'æœªåˆ†é¡'}</span>
      </div>
      ${profile.bio ? `<div class="profile-bio">${escapeHtml(profile.bio)}</div>` : ''}
      <div class="profile-display-id">${escapeHtml(profile.display_id || '')}</div>
      <button class="edit-profile-btn" id="edit-btn">âœï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</button>
      ${!profile.diagnosis_completed_at ? '<div class="mt-16"><a href="doppelganger-diagnosis.index.html" class="btn btn-primary btn-sm">è¨ºæ–­ã‚’å—ã‘ã‚‹</a></div>' : ''}
    `;

    // ç·¨é›†ãƒœã‚¿ãƒ³
    document.getElementById('edit-btn')?.addEventListener('click', () => showEditMode(false));

    // è¨ºæ–­å±¥æ­´
    renderDiagnosisHistory(profile.diagnosis_history);

    // è¨ºæ–­ã‚¹ã‚³ã‚¢
    if (profile.diagnosis_scores) {
      renderScores(profile.diagnosis_scores);
    }
  }

  // --- è¨ºæ–­å±¥æ­´è¡¨ç¤º ---
  function renderDiagnosisHistory(history) {
    if (!Array.isArray(history) || history.length === 0) return;
    const section = document.getElementById('history-section');
    const list = document.getElementById('history-list');
    section.style.display = 'block';

    const labels = ['æœ€æ–°', '1å›å‰', '2å›å‰'];
    list.innerHTML = history.slice(0, 3).map((h, i) => {
      const date = h.completed_at
        ? new Date(h.completed_at).toLocaleDateString('ja-JP', { year:'numeric', month:'short', day:'numeric' })
        : '';
      return `
        <div class="history-item">
          <span class="history-num">${labels[i] || (i + 'å›å‰')}</span>
          <div class="history-type">
            <div class="history-type-name">Type ${h.type_number || '?'}: ${escapeHtml(h.type_name || 'ä¸æ˜')}</div>
            <div class="history-type-sub">${escapeHtml(h.family || '')} Family ï½œ ${escapeHtml(h.type_code || '')}</div>
          </div>
          <span class="history-date">${date}</span>
        </div>
      `;
    }).join('');
  }

  // --- è¶£å‘³ã‚°ãƒªãƒƒãƒ‰ ---
  function renderHobbyGrid() {
    const grid = document.getElementById('hobby-grid');
    const hint = document.getElementById('hobby-limit-hint');
    const MAX = 3;

    grid.innerHTML = HOBBY_CATEGORIES.map(cat => {
      const sel = selectedHobbies.includes(cat.id);
      const dis = !sel && selectedHobbies.length >= MAX;
      return `
        <div class="hobby-chip ${sel ? 'selected' : ''} ${dis ? 'disabled' : ''}"
             data-cat-id="${cat.id}">
          <span class="hobby-chip-icon">${cat.icon}</span>
          <span>${escapeHtml(cat.name)}</span>
        </div>
      `;
    }).join('');

    hint.textContent = `${selectedHobbies.length} / ${MAX} é¸æŠ`;
    hint.classList.toggle('over', selectedHobbies.length > MAX);

    grid.querySelectorAll('.hobby-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const id = parseInt(chip.dataset.catId);
        if (selectedHobbies.includes(id)) {
          selectedHobbies = selectedHobbies.filter(h => h !== id);
        } else if (selectedHobbies.length < MAX) {
          selectedHobbies.push(id);
        } else {
          showToast('è¶£å‘³ã¯æœ€å¤§3ã¤ã¾ã§é¸æŠã§ãã¾ã™', 'error');
          return;
        }
        renderHobbyGrid();
      });
    });
  }

  // --- ã‚¢ãƒã‚¿ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ---
  function updateAvatarPreview() {
    const preview = document.getElementById('avatar-preview-content');
    const removeBtn = document.getElementById('avatar-remove-btn');

    if (pendingAvatarBlob) {
      preview.innerHTML = `<img src="${URL.createObjectURL(pendingAvatarBlob)}" alt="" style="width:80px;height:80px;object-fit:cover;border-radius:50%">`;
      removeBtn.style.display = 'block';
    } else if (currentProfile?.avatar_url) {
      preview.innerHTML = `<img src="${escapeHtml(currentProfile.avatar_url)}" alt="" style="width:80px;height:80px;object-fit:cover;border-radius:50%">`;
      removeBtn.style.display = 'block';
    } else {
      preview.textContent = currentProfile?.type_number ? getTypeEmoji(currentProfile.type_number) : 'ğŸ‘¤';
      removeBtn.style.display = 'none';
    }
  }

  // --- ç”»åƒé¸æŠã‚¤ãƒ™ãƒ³ãƒˆ ---
  document.getElementById('avatar-preview').addEventListener('click', () => {
    document.getElementById('avatar-input').click();
  });
  document.getElementById('avatar-upload-btn').addEventListener('click', () => {
    document.getElementById('avatar-input').click();
  });

  document.getElementById('avatar-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      pendingAvatarBlob = await Avatar.processImage(file);
      updateAvatarPreview();
      showToast('ç”»åƒã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ã€Œä¿å­˜ã™ã‚‹ã€ã§åæ˜ ã•ã‚Œã¾ã™', 'success');
    } catch (err) {
      showToast(err.message, 'error');
    }
    // input ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠå¯èƒ½ã«ã™ã‚‹ï¼‰
    e.target.value = '';
  });

  // ã‚¢ã‚¤ã‚³ãƒ³å‰Šé™¤
  document.getElementById('avatar-remove-btn').addEventListener('click', () => {
    pendingAvatarBlob = null;
    if (currentProfile) currentProfile._removeAvatar = true;
    updateAvatarPreview();
  });

  // --- æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ ---
  function updateCharCount(field) {
    const input = document.getElementById(`${field}-input`);
    const count = document.getElementById(`${field}-count`);
    const max = field === 'nickname' ? 20 : 100;
    count.textContent = input.value.length;
    count.parentElement.classList.toggle('over', input.value.length > max);
  }

  document.getElementById('nickname-input').addEventListener('input', () => updateCharCount('nickname'));
  document.getElementById('bio-input').addEventListener('input', () => updateCharCount('bio'));

  // --- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ ---
  document.getElementById('save-profile-btn').addEventListener('click', async () => {
    const nickname = document.getElementById('nickname-input').value.trim();
    const bio = document.getElementById('bio-input').value.trim();
    const usernameGroup = document.getElementById('username-form-group');
    const isUsernameVisible = usernameGroup && usernameGroup.style.display !== 'none';
    const usernameVal = isUsernameVisible ? document.getElementById('username-input').value.trim().toLowerCase() : null;

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: usernameï¼ˆåˆå›ã®ã¿ï¼‰
    if (isUsernameVisible) {
      if (!usernameVal) {
        document.getElementById('username-error').textContent = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        document.getElementById('username-error').classList.add('show');
        document.getElementById('username-input').focus();
        return;
      }
      if (!/^[a-z0-9_]{3,20}$/.test(usernameVal)) {
        document.getElementById('username-error').textContent = '3ã€œ20æ–‡å­—ã®åŠè§’è‹±æ•°å­—ãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨ã§ãã¾ã™';
        document.getElementById('username-error').classList.add('show');
        document.getElementById('username-input').focus();
        return;
      }
      document.getElementById('username-error').classList.remove('show');
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: nickname
    if (!nickname) {
      document.getElementById('nickname-error').classList.add('show');
      document.getElementById('nickname-input').focus();
      return;
    }
    document.getElementById('nickname-error').classList.remove('show');

    const btn = document.getElementById('save-profile-btn');
    btn.disabled = true;
    btn.textContent = 'ä¿å­˜ä¸­...';

    try {
      // ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if (pendingAvatarBlob) {
        await Avatar.uploadAvatar(pendingAvatarBlob);
        pendingAvatarBlob = null;
      } else if (currentProfile?._removeAvatar) {
        await Avatar.deleteAvatar();
        delete currentProfile._removeAvatar;
      }

      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ï¼ˆusername / ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  / è¶£å‘³ ã‚’å«ã‚€ï¼‰
      await Auth.saveProfile(nickname, bio, selectedHobbies, usernameVal);

      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
      currentProfile = await getMyProfile(true);

      showToast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');

      // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ãªã‚‰è¨ºæ–­ãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼ˆæ–°ãƒ•ãƒ­ãƒ¼ï¼‰
      if (isSetupMode) {
        setTimeout(() => { window.location.href = 'doppelganger-diagnosis.index.html'; }, 800);
      } else {
        showViewMode();
        initNavUser();
      }
    } catch (err) {
      if (err.message && err.message.includes('duplicate key') || (err.code === '23505')) {
        document.getElementById('username-error').textContent = 'ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã¯ã™ã§ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™';
        document.getElementById('username-error').classList.add('show');
      } else {
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
      }
    } finally {
      btn.disabled = false;
      btn.textContent = 'ä¿å­˜ã™ã‚‹';
    }
  });

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  document.getElementById('cancel-edit-btn').addEventListener('click', () => {
    pendingAvatarBlob = null;
    showViewMode();
  });

  // --- ã‚¹ã‚³ã‚¢è¡¨ç¤º ---
  function renderScores(scores) {
    const section = document.getElementById('scores-section');
    section.style.display = 'block';

    const container = document.getElementById('diagnosis-scores');
    const entries = Object.entries(scores);
    const initial = entries.slice(0, 6);
    const rest = entries.slice(6);

    container.innerHTML = initial.map(([key, val]) => `
      <div class="score-item">
        <span class="score-name">${P_NAMES[key] || key}</span>
        <span class="score-value">${val}</span>
      </div>
    `).join('');

    if (rest.length > 0) {
      const toggle = document.getElementById('scores-toggle');
      let expanded = false;

      toggle.addEventListener('click', () => {
        expanded = !expanded;
        container.innerHTML = (expanded ? entries : initial).map(([key, val]) => `
          <div class="score-item">
            <span class="score-name">${P_NAMES[key] || key}</span>
            <span class="score-value">${val}</span>
          </div>
        `).join('');
        toggle.textContent = expanded ? 'é–‰ã˜ã‚‹ â–²' : 'ã‚‚ã£ã¨è¦‹ã‚‹ â–¼';
      });
    } else {
      document.getElementById('scores-toggle').style.display = 'none';
    }
  }

  // --- çµ±è¨ˆèª­ã¿è¾¼ã¿ ---
  async function loadStats(userId) {
    try {
      const [postsResult, likesResult] = await Promise.all([
        supabase.from('posts').select('id', { count: 'exact', head: true }).eq('user_id', userId),
        supabase.from('likes').select('post_id', { count: 'exact', head: true })
          .in('post_id',
            (await supabase.from('posts').select('id').eq('user_id', userId)).data?.map(p => p.id) || []
          ),
      ]);

      document.getElementById('profile-stats').innerHTML = `
        <div class="stat-item">
          <div class="stat-value">${postsResult.count || 0}</div>
          <div class="stat-label">æŠ•ç¨¿æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${likesResult.count || 0}</div>
          <div class="stat-label">ã‚‚ã‚‰ã£ãŸ â¤ï¸</div>
        </div>
      `;
    } catch(e) {
      // çµ±è¨ˆèª­ã¿è¾¼ã¿å¤±æ•—ã¯ç„¡è¦–
    }
  }

  // --- è¶£å‘³ç·¨é›†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ---
  document.getElementById('edit-hobby-btn')?.addEventListener('click', () => {
    showEditMode(false);
    setTimeout(() => {
      document.getElementById('hobby-form-group')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  });

  // --- ã‚·ã‚§ã‚¢æ©Ÿèƒ½ ---
  document.getElementById('share-btn').addEventListener('click', async () => {
    const profile = await getMyProfile();
    if (!profile || !profile.type_name) {
      showToast('è¨ºæ–­çµæœãŒã‚ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    const shareText = `Doppelganger æ€§æ ¼è¨ºæ–­ã®çµæœ\n\n` +
      `ğŸ­ Type ${profile.type_number}: ${profile.type_name}\n` +
      `ğŸ“¦ ${profile.family} Family\n\n` +
      `ã‚ãªãŸã‚‚è‡ªåˆ†ã®ã€Œç²¾ç¥ã®è¨­è¨ˆå›³ã€ã‚’è¦‹ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ`;

    if (navigator.share) {
      try {
        await navigator.share({ title: 'Doppelganger è¨ºæ–­çµæœ', text: shareText });
      } catch (e) {}
    } else {
      try {
        await navigator.clipboard.writeText(shareText);
        showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
      } catch (e) {
        showToast('ã‚·ã‚§ã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }
  });

  // --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ---
  document.getElementById('logout-btn').addEventListener('click', async () => {
    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
      await Auth.signOut();
    }
  });

  // ã‚¿ã‚¤ãƒ—çµµæ–‡å­—ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (typeof getTypeEmoji === 'undefined') {
    window.getTypeEmoji = function(n) {
      const e = {1:'ğŸ¦‰',2:'ğŸ§­',3:'ğŸ›¡ï¸',4:'â™Ÿï¸',5:'ğŸ”',6:'âš™ï¸',7:'ğŸ°',8:'ğŸ‘‘',
        9:'ğŸŒŒ',10:'ğŸŒ¬ï¸',11:'ğŸŒ™',12:'ğŸ¼',13:'ğŸŒŠ',14:'âš¡',15:'ğŸ­',16:'ğŸƒ',
        17:'ğŸ•Šï¸',18:'ğŸ¦…',19:'âšœï¸',20:'ğŸ¦',21:'âš–ï¸',22:'ğŸ”¥',23:'âš’ï¸',24:'ğŸ›ï¸',
        25:'â˜€ï¸',26:'ğŸ”¥',27:'ğŸŒ¿',28:'ğŸŒŸ',29:'ğŸª',30:'ğŸŒªï¸',31:'âœ¨',32:'ğŸ­'};
      return e[n] || 'ğŸ‘¤';
    };
  }

  init();
})();
</script>
</body>
</html>
