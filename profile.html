<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Doppelganger - ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
<link rel="stylesheet" href="css/common.css">
<style>
  .profile-card{
    background:linear-gradient(145deg,var(--surface),var(--surface2));
    border:1px solid var(--surface3);
    border-radius:20px;padding:28px 24px;
    box-shadow:var(--shadow);text-align:center;
    margin-bottom:16px;animation:fadeIn .5s ease;
  }
  .profile-icon{
    width:80px;height:80px;border-radius:50%;
    margin:0 auto 14px;
    display:flex;align-items:center;justify-content:center;
    font-size:2.2rem;animation:float 4s ease-in-out infinite;
  }
  .profile-type-name{
    font-size:1.3rem;font-weight:900;
    background:linear-gradient(135deg,var(--accent),var(--accent2),var(--pink));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    margin-bottom:4px;
  }
  .profile-type-sub{font-size:.82rem;color:var(--text2);margin-bottom:12px}
  .profile-display-id{
    display:inline-block;
    padding:4px 14px;border-radius:20px;
    background:var(--surface);border:1px solid var(--surface3);
    font-size:.82rem;color:var(--text);font-weight:600;
    letter-spacing:.05em;
  }

  .profile-stats{
    display:grid;grid-template-columns:1fr 1fr;gap:8px;
    margin:16px 0;
  }
  .stat-item{
    background:var(--surface);border:1px solid var(--surface3);
    border-radius:var(--radius);padding:14px;text-align:center;
  }
  .stat-value{font-size:1.2rem;font-weight:700;color:var(--accent2)}
  .stat-label{font-size:.7rem;color:var(--text2);margin-top:4px}

  .profile-section{margin-bottom:16px}
  .profile-section .section-title{margin-bottom:8px}

  .menu-item{
    display:flex;align-items:center;gap:12px;
    padding:14px 16px;
    background:var(--surface);border:1px solid var(--surface3);
    border-radius:var(--radius);margin-bottom:8px;
    cursor:pointer;transition:all .2s;
    text-decoration:none;color:var(--text);
  }
  .menu-item:hover{border-color:rgba(108,92,231,.3);transform:translateX(4px)}
  .menu-icon{font-size:1.2rem;flex-shrink:0;width:32px;text-align:center}
  .menu-label{flex:1;font-size:.88rem;font-weight:500}
  .menu-arrow{color:var(--text2);font-size:.9rem}

  .logout-btn{
    width:100%;padding:14px;margin-top:24px;
    background:transparent;border:1px solid rgba(225,112,85,.3);
    border-radius:var(--radius);color:var(--danger);
    font-size:.88rem;font-weight:600;cursor:pointer;
    transition:all .2s;
  }
  .logout-btn:hover{background:rgba(225,112,85,.06);border-color:var(--danger)}

  .diagnosis-scores{
    display:grid;grid-template-columns:1fr 1fr;gap:6px;
    margin-top:8px;
  }
  .score-item{
    display:flex;justify-content:space-between;align-items:center;
    padding:6px 10px;background:var(--surface2);border-radius:8px;
    font-size:.75rem;
  }
  .score-name{color:var(--text2)}
  .score-value{color:var(--accent2);font-weight:600}

  .scores-toggle{
    display:block;margin:8px auto 0;
    padding:6px 16px;border:1px solid var(--surface3);
    border-radius:50px;background:transparent;color:var(--text2);
    font-size:.75rem;cursor:pointer;transition:all .2s;
  }
  .scores-toggle:hover{border-color:var(--accent);color:var(--text)}
</style>
</head>
<body>

<div class="page" id="page">
  <div class="container">

    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ -->
    <div class="profile-card" id="profile-card">
      <div class="loading"><div class="spinner"></div></div>
    </div>

    <!-- çµ±è¨ˆ -->
    <div class="profile-stats" id="profile-stats"></div>

    <!-- På¤‰æ•°ã‚¹ã‚³ã‚¢ -->
    <div class="profile-section" id="scores-section" style="display:none">
      <div class="section-title">è¨ºæ–­ã‚¹ã‚³ã‚¢ï¼ˆéå…¬é–‹ï¼‰</div>
      <div class="card">
        <div class="diagnosis-scores" id="diagnosis-scores"></div>
        <button class="scores-toggle" id="scores-toggle">ã‚‚ã£ã¨è¦‹ã‚‹ â–¼</button>
      </div>
    </div>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="profile-section">
      <div class="section-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>

      <a href="doppelganger-diagnosis.index.html" class="menu-item">
        <span class="menu-icon">ğŸ”®</span>
        <span class="menu-label">è¨ºæ–­ã‚’ã‚„ã‚Šç›´ã™</span>
        <span class="menu-arrow">â€º</span>
      </a>

      <a href="board.html" class="menu-item">
        <span class="menu-icon">ğŸ’¬</span>
        <span class="menu-label">æ²ç¤ºæ¿ã¸</span>
        <span class="menu-arrow">â€º</span>
      </a>

      <div class="menu-item" id="share-btn">
        <span class="menu-icon">ğŸ“¤</span>
        <span class="menu-label">è¨ºæ–­çµæœã‚’ã‚·ã‚§ã‚¢</span>
        <span class="menu-arrow">â€º</span>
      </div>
    </div>

    <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ -->
    <button class="logout-btn" id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

    <div class="text-center mt-16 text-xs text-muted">
      Doppelganger v1.0
    </div>
  </div>
</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<nav class="nav-bar">
  <a href="board.html" class="nav-item">
    <span class="nav-icon">ğŸ’¬</span>
    <span>æ²ç¤ºæ¿</span>
  </a>
  <a href="doppelganger-diagnosis.index.html" class="nav-item">
    <span class="nav-icon">ğŸ”®</span>
    <span>è¨ºæ–­</span>
  </a>
  <a href="profile.html" class="nav-item active">
    <span class="nav-icon">ğŸ‘¤</span>
    <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
  </a>
</nav>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="js/supabase-config.js"></script>
<script src="js/auth.js"></script>
<script>
(function() {
  const P_NAMES = {
    P1:'ç¤¾ä¼šä¹–é›¢å€¤',P2:'åˆç†æ€§',P3:'å¯¾äººè·é›¢',P4:'ä¸»å¾“',
    P5:'è–åŸŸ',P6:'å­¤é«˜åº¦',P7:'è¦šé†’å‹•æ©Ÿ',P8:'æƒ…ç·’å¤‰å‹•æ€§',
    P9:'ç§©åºæ€§',P10:'æ¢ç´¢æ¬²',P11:'æ„Ÿæƒ…éœ²å‡ºåº¦',P12:'ä¾å­˜æ§‹é€ ',
    P13:'å¯¾è©±æ§‹é€ ',P14:'æ„›ç€è¡¨ç¾',P15:'è‘›è—¤å¯¾å‡¦',
  };

  async function init() {
    try {
      const user = await requireAuth();
      if (!user) return;

      const profile = await getMyProfile(true);
      if (!profile) {
        window.location.href = 'index.html';
        return;
      }

      renderProfile(profile);
      await loadStats(user.id);
    } catch (err) {
      showToast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  }

  function renderProfile(profile) {
    const fam = profile.family || '';
    const colorVar = familyColor(fam);
    const badgeClass = fam ? `badge-${fam.toLowerCase()}` : '';

    document.getElementById('profile-card').innerHTML = `
      <div class="profile-icon" style="background:rgba(${colorVar},.12);border:2px solid rgba(${colorVar},.3)">
        ${getTypeEmoji(profile.type_number)}
      </div>
      <div class="profile-type-name">Type ${profile.type_number || '?'}: ${escapeHtml(profile.type_name || 'æœªè¨ºæ–­')}</div>
      <div class="profile-type-sub">
        <span class="badge ${badgeClass}">${fam || 'æœªåˆ†é¡'}</span>
      </div>
      <div class="profile-display-id">${escapeHtml(profile.display_id || '')}</div>
      ${!profile.diagnosis_completed_at ? '<div class="mt-16"><a href="doppelganger-diagnosis.index.html" class="btn btn-primary btn-sm">è¨ºæ–­ã‚’å—ã‘ã‚‹</a></div>' : ''}
    `;

    // è¨ºæ–­ã‚¹ã‚³ã‚¢
    if (profile.diagnosis_scores) {
      renderScores(profile.diagnosis_scores);
    }
  }

  function renderScores(scores) {
    const section = document.getElementById('scores-section');
    section.style.display = 'block';

    const container = document.getElementById('diagnosis-scores');
    const entries = Object.entries(scores);
    // æœ€åˆã¯6å€‹è¡¨ç¤º
    const initial = entries.slice(0, 6);
    const rest = entries.slice(6);

    container.innerHTML = initial.map(([key, val]) => `
      <div class="score-item">
        <span class="score-name">${P_NAMES[key] || key}</span>
        <span class="score-value">${val}</span>
      </div>
    `).join('');

    if (rest.length > 0) {
      const toggle = document.getElementById('scores-toggle');
      let expanded = false;

      toggle.addEventListener('click', () => {
        expanded = !expanded;
        if (expanded) {
          container.innerHTML = entries.map(([key, val]) => `
            <div class="score-item">
              <span class="score-name">${P_NAMES[key] || key}</span>
              <span class="score-value">${val}</span>
            </div>
          `).join('');
          toggle.textContent = 'é–‰ã˜ã‚‹ â–²';
        } else {
          container.innerHTML = initial.map(([key, val]) => `
            <div class="score-item">
              <span class="score-name">${P_NAMES[key] || key}</span>
              <span class="score-value">${val}</span>
            </div>
          `).join('');
          toggle.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹ â–¼';
        }
      });
    } else {
      document.getElementById('scores-toggle').style.display = 'none';
    }
  }

  async function loadStats(userId) {
    // æŠ•ç¨¿æ•°ã¨ã„ã„ã­æ•°ã‚’å–å¾—
    const [postsResult, likesResult] = await Promise.all([
      supabase.from('posts').select('id', { count: 'exact', head: true }).eq('user_id', userId),
      supabase.from('likes').select('post_id', { count: 'exact', head: true })
        .in('post_id',
          (await supabase.from('posts').select('id').eq('user_id', userId)).data?.map(p => p.id) || []
        ),
    ]);

    const postCount = postsResult.count || 0;
    const likeCount = likesResult.count || 0;

    document.getElementById('profile-stats').innerHTML = `
      <div class="stat-item">
        <div class="stat-value">${postCount}</div>
        <div class="stat-label">æŠ•ç¨¿æ•°</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${likeCount}</div>
        <div class="stat-label">ã‚‚ã‚‰ã£ãŸ â¤ï¸</div>
      </div>
    `;
  }

  // --- ã‚·ã‚§ã‚¢æ©Ÿèƒ½ ---
  document.getElementById('share-btn').addEventListener('click', async () => {
    const profile = await getMyProfile();
    if (!profile || !profile.type_name) {
      showToast('è¨ºæ–­çµæœãŒã‚ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    const shareText = `Doppelganger æ€§æ ¼è¨ºæ–­ã®çµæœ\n\n` +
      `ğŸ­ Type ${profile.type_number}: ${profile.type_name}\n` +
      `ğŸ“¦ ${profile.family} Family\n\n` +
      `ã‚ãªãŸã‚‚è‡ªåˆ†ã®ã€Œç²¾ç¥ã®è¨­è¨ˆå›³ã€ã‚’è¦‹ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ`;

    if (navigator.share) {
      try {
        await navigator.share({ title: 'Doppelganger è¨ºæ–­çµæœ', text: shareText });
      } catch (e) { /* ã‚­ãƒ£ãƒ³ã‚»ãƒ« */ }
    } else {
      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
      try {
        await navigator.clipboard.writeText(shareText);
        showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
      } catch (e) {
        showToast('ã‚·ã‚§ã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }
  });

  // --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ---
  document.getElementById('logout-btn').addEventListener('click', async () => {
    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
      await Auth.signOut();
    }
  });

  // ã‚¿ã‚¤ãƒ—çµµæ–‡å­—ï¼ˆboard.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  if (typeof getTypeEmoji === 'undefined') {
    window.getTypeEmoji = function(n) {
      const e = {1:'ğŸ¦‰',2:'ğŸ§­',3:'ğŸ›¡ï¸',4:'â™Ÿï¸',5:'ğŸ”',6:'âš™ï¸',7:'ğŸ°',8:'ğŸ‘‘',
        9:'ğŸŒŒ',10:'ğŸŒ¬ï¸',11:'ğŸŒ™',12:'ğŸ¼',13:'ğŸŒŠ',14:'âš¡',15:'ğŸ­',16:'ğŸƒ',
        17:'ğŸ•Šï¸',18:'ğŸ¦…',19:'âšœï¸',20:'ğŸ¦',21:'âš–ï¸',22:'ğŸ”¥',23:'âš’ï¸',24:'ğŸ›ï¸',
        25:'â˜€ï¸',26:'ğŸ”¥',27:'ğŸŒ¿',28:'ğŸŒŸ',29:'ğŸª',30:'ğŸŒªï¸',31:'âœ¨',32:'ğŸ­'};
      return e[n] || 'ğŸ‘¤';
    };
  }

  init();
})();
</script>
</body>
</html>
