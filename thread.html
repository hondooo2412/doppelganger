<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Doppelganger - ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<link rel="stylesheet" href="css/common.css">
<style>
  .thread-header-card{
    background:var(--surface);border:1px solid var(--surface3);
    border-radius:var(--radius);padding:18px;margin-bottom:16px;
  }
  .thread-header-title{
    font-size:1.05rem;font-weight:700;line-height:1.5;margin-bottom:10px;
  }
  .thread-header-meta{
    display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    font-size:.75rem;color:var(--text2);
  }
  .thread-status{
    display:flex;align-items:center;gap:4px;
    font-size:.72rem;color:var(--warning);
  }

  /* è¿”ä¿¡å…¥åŠ›ã‚¨ãƒªã‚¢ */
  .reply-area{
    position:fixed;bottom:60px;left:0;right:0;
    padding:10px 16px;padding-bottom:calc(10px + env(safe-area-inset-bottom,0px));
    background:var(--surface);border-top:1px solid var(--surface3);
    z-index:50;
    display:flex;gap:8px;align-items:flex-end;
  }
  .reply-area textarea{
    flex:1;
    padding:10px 14px;
    background:var(--surface2);border:1px solid var(--surface3);
    border-radius:20px;color:var(--text);
    font-size:.85rem;line-height:1.5;
    resize:none;outline:none;
    min-height:40px;max-height:120px;
    font-family:inherit;
    -webkit-appearance:none;
  }
  .reply-area textarea:focus{border-color:var(--accent)}
  .reply-area textarea::placeholder{color:var(--text2);opacity:.6}
  .reply-send-btn{
    width:40px;height:40px;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border:none;border-radius:50%;
    color:#fff;font-size:1rem;
    cursor:pointer;flex-shrink:0;
    display:flex;align-items:center;justify-content:center;
    transition:all .2s;
  }
  .reply-send-btn:hover{transform:scale(1.1)}
  .reply-send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

  .reply-warning{
    font-size:.7rem;color:var(--danger);
    padding:0 16px;margin-bottom:4px;
    display:none;
  }
  .reply-warning.show{display:block}

  /* æŠ•ç¨¿ä¸€è¦§ã®ä¸‹ä½™ç™½ï¼ˆè¿”ä¿¡ã‚¨ãƒªã‚¢ã¨é‡ãªã‚‰ãªã„ã‚ˆã†ï¼‰ */
  .posts-container{padding-bottom:80px}

  /* ã‚¹ãƒ¬ãƒƒãƒ‰ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆ */
  .locked-notice{
    text-align:center;padding:16px;
    color:var(--text2);font-size:.85rem;
    background:var(--surface);border:1px solid var(--surface3);
    border-radius:var(--radius);
  }

  /* å‰Šé™¤ç¢ºèª */
  .delete-confirm{
    display:flex;align-items:center;gap:8px;
    padding:8px 12px;margin-top:-6px;margin-bottom:10px;
    background:rgba(225,112,85,.06);border:1px solid rgba(225,112,85,.2);
    border-radius:10px;font-size:.78rem;color:var(--danger);
    animation:fadeIn .2s ease;
  }
  .delete-confirm button{
    padding:4px 12px;border-radius:6px;font-size:.75rem;
    cursor:pointer;border:none;font-weight:600;
  }
  .delete-yes{background:var(--danger);color:#fff}
  .delete-no{background:var(--surface3);color:var(--text2)}
</style>
</head>
<body>

<div class="page" id="page">
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="page-header">
      <button class="back-btn" id="back-btn">â†</button>
      <div>
        <div class="page-title" id="board-name"></div>
      </div>
    </div>

    <!-- ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="thread-header-card" id="thread-header"></div>

    <!-- æŠ•ç¨¿ä¸€è¦§ -->
    <div class="posts-container" id="posts-container"></div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading hidden" id="loading">
      <div class="spinner"></div>
      <span>èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
  </div>
</div>

<!-- è¿”ä¿¡ã‚¨ãƒªã‚¢ -->
<div id="reply-area-wrapper">
  <div class="reply-warning" id="reply-warning"></div>
  <div class="reply-area" id="reply-area">
    <textarea id="reply-input" placeholder="è¿”ä¿¡ã‚’æ›¸ã..." rows="1"></textarea>
    <button class="reply-send-btn" id="reply-send" disabled>â–¶</button>
  </div>
</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<nav class="nav-bar" style="display:none" id="nav-bar">
  <a href="board.html" class="nav-item">
    <span class="nav-icon">ğŸ’¬</span>
    <span>æ²ç¤ºæ¿</span>
  </a>
  <a href="doppelganger-diagnosis.index.html" class="nav-item">
    <span class="nav-icon">ğŸ”®</span>
    <span>è¨ºæ–­</span>
  </a>
  <a href="profile.html" class="nav-item">
    <span class="nav-icon">ğŸ‘¤</span>
    <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
  </a>
</nav>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="js/supabase-config.js"></script>
<script src="js/auth.js"></script>
<script src="js/moderation.js"></script>
<script src="js/board.js"></script>
<script>
(function() {
  let currentThread = null;
  let currentUserId = null;
  let realtimeChannel = null;

  // --- åˆæœŸåŒ– ---
  async function init() {
    showLoading(true);
    try {
      const user = await requireAuth();
      if (!user) return;
      currentUserId = user.id;

      const profile = await requireDiagnosis();
      if (!profile) return;

      const params = new URLSearchParams(window.location.search);
      const threadId = params.get('id');
      if (!threadId) {
        window.location.href = 'board.html';
        return;
      }

      await loadThread(threadId);
    } catch (err) {
      showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // --- ã‚¹ãƒ¬ãƒƒãƒ‰èª­ã¿è¾¼ã¿ ---
  async function loadThread(threadId) {
    currentThread = await Board.getThread(threadId);
    const board = currentThread.board;

    // ãƒ˜ãƒƒãƒ€ãƒ¼
    document.getElementById('board-name').textContent = board.name;
    document.getElementById('back-btn').addEventListener('click', () => {
      window.location.href = `board.html?id=${board.id}`;
    });

    const user = currentThread.user || {};
    const fam = user.family || 'Architects';
    const badgeClass = `badge-${fam.toLowerCase()}`;

    let statusHtml = '';
    if (currentThread.is_pinned) statusHtml += '<span class="thread-status">ğŸ“Œ å›ºå®šã‚¹ãƒ¬ãƒƒãƒ‰</span>';
    if (currentThread.is_locked) statusHtml += '<span class="thread-status">ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­</span>';

    document.getElementById('thread-header').innerHTML = `
      <div class="thread-header-title">${escapeHtml(currentThread.title)}</div>
      <div class="thread-header-meta">
        <span class="badge ${badgeClass}">${escapeHtml(user.type_name || 'ä¸æ˜')}</span>
        <span>${escapeHtml(user.display_id || '')}</span>
        <span>ğŸ’¬ ${currentThread.reply_count}ä»¶</span>
        <span>${timeAgo(currentThread.created_at)}</span>
        ${statusHtml}
      </div>
    `;

    // ãƒ­ãƒƒã‚¯ä¸­ã¯è¿”ä¿¡ä¸å¯
    if (currentThread.is_locked) {
      document.getElementById('reply-area-wrapper').innerHTML = `
        <div class="locked-notice" style="position:fixed;bottom:0;left:0;right:0;z-index:50;border-radius:0">
          ğŸ”’ ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™
        </div>
      `;
    }

    // æŠ•ç¨¿ä¸€è¦§
    await loadPosts(threadId);

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­
    realtimeChannel = Board.subscribeToThread(threadId, (newPost) => {
      if (newPost.user_id !== currentUserId) {
        appendPost(newPost, false, false);
        scrollToBottom();
      }
    });
  }

  // --- æŠ•ç¨¿ä¸€è¦§èª­ã¿è¾¼ã¿ ---
  async function loadPosts(threadId) {
    const container = document.getElementById('posts-container');
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

    const { posts } = await Board.getPosts(threadId, { limit: 200 });
    const postIds = posts.map(p => p.id);
    const myLikes = await Board.getMyLikes(postIds);

    container.innerHTML = '';
    posts.forEach(post => {
      const isLiked = myLikes.has(post.id);
      const isOwn = post.user_id === currentUserId;
      appendPost(post, isLiked, isOwn);
    });

    if (posts.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ğŸ’­</div>
          <div class="empty-text">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      `;
    }
  }

  // --- æŠ•ç¨¿ã‚’è¿½åŠ  ---
  function appendPost(post, isLiked, isOwn) {
    const container = document.getElementById('posts-container');
    const div = document.createElement('div');
    div.innerHTML = Board.renderPostCard(post, isLiked, isOwn);
    const card = div.firstElementChild;
    container.appendChild(card);

    // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    setupPostActions(card);
  }

  // --- æŠ•ç¨¿ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---
  function setupPostActions(card) {
    card.querySelectorAll('.post-action').forEach(btn => {
      btn.addEventListener('click', async () => {
        const action = btn.dataset.action;
        const postId = btn.dataset.postId;

        if (action === 'like') {
          await handleLike(btn, postId);
        } else if (action === 'report') {
          Moderation.showReportModal(postId);
        } else if (action === 'delete') {
          handleDelete(btn, postId, card);
        }
      });
    });
  }

  // --- ã„ã„ã­å‡¦ç† ---
  async function handleLike(btn, postId) {
    try {
      const liked = await Board.toggleLike(postId);
      const countEl = btn.querySelector('.like-count');
      let count = parseInt(countEl.textContent) || 0;

      if (liked) {
        btn.classList.add('liked');
        btn.innerHTML = `â¤ï¸ <span class="like-count">${count + 1}</span>`;
      } else {
        btn.classList.remove('liked');
        btn.innerHTML = `ğŸ¤ <span class="like-count">${Math.max(0, count - 1)}</span>`;
      }
    } catch (err) {
      showToast('ã„ã„ã­ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  }

  // --- å‰Šé™¤å‡¦ç† ---
  function handleDelete(btn, postId, card) {
    // æ—¢ã«ç¢ºèªè¡¨ç¤ºä¸­ãªã‚‰ç„¡è¦–
    if (card.querySelector('.delete-confirm')) return;

    const confirm = document.createElement('div');
    confirm.className = 'delete-confirm';
    confirm.innerHTML = `
      <span>ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</span>
      <button class="delete-yes">å‰Šé™¤</button>
      <button class="delete-no">ã‚„ã‚ã‚‹</button>
    `;

    card.appendChild(confirm);

    confirm.querySelector('.delete-no').addEventListener('click', () => {
      confirm.remove();
    });

    confirm.querySelector('.delete-yes').addEventListener('click', async () => {
      try {
        await Board.deletePost(postId);
        card.style.animation = 'fadeOut .3s ease forwards';
        setTimeout(() => card.remove(), 300);
        showToast('æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
      } catch (err) {
        showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        confirm.remove();
      }
    });
  }

  // --- è¿”ä¿¡å…¥åŠ› ---
  const replyInput = document.getElementById('reply-input');
  const sendBtn = document.getElementById('reply-send');
  const warningEl = document.getElementById('reply-warning');

  replyInput.addEventListener('input', () => {
    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢é«˜ã•è‡ªå‹•èª¿æ•´
    replyInput.style.height = 'auto';
    replyInput.style.height = Math.min(replyInput.scrollHeight, 120) + 'px';

    // é€ä¿¡ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
    const text = replyInput.value.trim();
    sendBtn.disabled = text.length === 0;

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
    if (text.length > 0) {
      const check = Moderation.checkContent(text);
      if (!check.ok) {
        warningEl.textContent = check.reason;
        warningEl.classList.add('show');
        sendBtn.disabled = true;
      } else {
        warningEl.classList.remove('show');
      }
    } else {
      warningEl.classList.remove('show');
    }
  });

  // é€ä¿¡
  sendBtn.addEventListener('click', submitReply);
  replyInput.addEventListener('keydown', (e) => {
    // Ctrl+Enter or Cmd+Enter ã§é€ä¿¡
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      submitReply();
    }
  });

  async function submitReply() {
    const content = replyInput.value.trim();
    if (!content) return;

    sendBtn.disabled = true;

    try {
      const post = await Board.createPost(currentThread.id, content);
      appendPost(post, false, true);
      replyInput.value = '';
      replyInput.style.height = 'auto';
      warningEl.classList.remove('show');
      scrollToBottom();
    } catch (err) {
      showToast(err.message || 'æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    } finally {
      sendBtn.disabled = replyInput.value.trim().length === 0;
    }
  }

  // --- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ---
  function scrollToBottom() {
    setTimeout(() => {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }, 100);
  }

  // --- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ---
  function showLoading(show) {
    document.getElementById('loading').classList.toggle('hidden', !show);
  }

  // --- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ---
  window.addEventListener('beforeunload', () => {
    if (realtimeChannel) {
      supabase.removeChannel(realtimeChannel);
    }
  });

  // --- èµ·å‹• ---
  init();
})();
</script>
</body>
</html>
