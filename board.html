<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Doppelganger - æ²ç¤ºæ¿</title>
<link rel="stylesheet" href="css/common.css">
<style>
/* ============================================================
   æ²ç¤ºæ¿ å…±é€š
   ============================================================ */
.board-logo {
  font-size: 1.3rem; font-weight: 900;
  background: linear-gradient(135deg, #6c5ce7, #a29bfe, #fd79a8);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.board-logo-sub { font-size: .68rem; color: var(--text2); letter-spacing: .15em; }

/* ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ */
.breadcrumb {
  display: flex; align-items: center; gap: 4px;
  font-size: .75rem; color: var(--text2);
  padding: 8px 0 12px; flex-wrap: wrap;
}
.breadcrumb-item { cursor: pointer; }
.breadcrumb-item:hover { color: var(--accent2); }
.breadcrumb-sep { opacity: .4; }
.breadcrumb-current { color: var(--text); font-weight: 600; }

/* ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºåˆ¶å¾¡ */
.view { display: none; }
.view.active { display: block; }

/* ============================================================
   ãƒ“ãƒ¥ãƒ¼â‘  TOP
   ============================================================ */
.my-type-banner {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 16px; margin: 16px 0 20px;
  background: var(--surface); border: 1px solid var(--surface3);
  border-radius: var(--radius);
}
.my-type-icon {
  width: 44px; height: 44px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.35rem; flex-shrink: 0;
}
.my-type-info { flex: 1; min-width: 0; }
.my-type-name { font-size: .9rem; font-weight: 700; }
.my-type-sub  { font-size: .72rem; color: var(--text2); margin-top: 2px; }

/* ãŠã™ã™ã‚ã®æ¿ */
.recommend-section { margin-bottom: 24px; }
.recommend-hint {
  font-size: .75rem; color: var(--text2);
  margin-bottom: 8px; padding-left: 4px;
}
.recommend-chips {
  display: flex; gap: 8px; flex-wrap: wrap;
}
.recommend-chip {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 6px 14px;
  background: var(--surface); border: 1px solid var(--surface3);
  border-radius: 50px; font-size: .8rem; cursor: pointer;
  transition: all .2s;
}
.recommend-chip:hover { border-color: var(--accent); color: var(--accent2); }

/* ã‚¨ãƒªã‚¢é¸æŠã‚«ãƒ¼ãƒ‰ */
.area-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.area-card {
  padding: 18px 14px;
  background: var(--surface); border: 1px solid var(--surface3);
  border-radius: var(--radius); cursor: pointer;
  transition: all .25s; text-align: center;
}
.area-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow); }
.area-card-icon { font-size: 1.8rem; margin-bottom: 8px; }
.area-card-name { font-size: .85rem; font-weight: 700; margin-bottom: 4px; }
.area-card-desc { font-size: .7rem; color: var(--text2); line-height: 1.4; }
.area-card.family-card { border-left: 3px solid var(--accent); }
.area-card.type-card   { border-left: 3px solid var(--accent2); }

/* ============================================================
   ãƒ“ãƒ¥ãƒ¼â‘¡ å¤§ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ï¼ˆ2ché¢¨ï¼‰
   ============================================================ */
.category-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 8px;
}
.category-card {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px;
  background: var(--surface); border: 1px solid var(--surface3);
  border-radius: var(--radius); cursor: pointer;
  transition: all .2s;
}
.category-card:hover { border-color: var(--accent); background: var(--surface2); }
.category-icon { font-size: 1.3rem; flex-shrink: 0; }
.category-name { font-size: .85rem; font-weight: 600; }

/* ============================================================
   ãƒ“ãƒ¥ãƒ¼â‘¢ ä¸­ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ï¼ˆæ¿ä¸€è¦§ï¼‰
   ============================================================ */
.subcategory-list { display: flex; flex-direction: column; gap: 8px; }
.subcategory-row {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 16px;
  background: var(--surface); border: 1px solid var(--surface3);
  border-radius: var(--radius); cursor: pointer;
  transition: all .2s;
}
.subcategory-row:hover { border-color: var(--accent); }
.subcategory-icon { font-size: 1.1rem; flex-shrink: 0; }
.subcategory-name { flex: 1; font-size: .88rem; font-weight: 600; }
.subcategory-count { font-size: .72rem; color: var(--text2); }
.subcategory-arrow { color: var(--text2); font-size: 1rem; }

/* ============================================================
   ãƒ“ãƒ¥ãƒ¼â‘£ æ¿ä¸€è¦§ï¼ˆå°ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‰
   ============================================================ */
.board-list-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.new-board-btn {
  display: flex; align-items: center; gap: 4px;
  padding: 8px 16px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff; border: none; border-radius: 50px;
  font-size: .8rem; font-weight: 600; cursor: pointer;
  transition: all .3s;
}
.new-board-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(108,92,231,.4); }

.board-card-item {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 14px 16px;
  background: var(--surface); border: 1px solid var(--surface3);
  border-radius: var(--radius); cursor: pointer;
  transition: all .2s; margin-bottom: 8px;
  text-decoration: none; color: inherit;
}
.board-card-item:hover { border-color: var(--accent); }
.board-card-icon { font-size: 1.4rem; flex-shrink: 0; margin-top: 2px; }
.board-card-body { flex: 1; min-width: 0; }
.board-card-name { font-size: .9rem; font-weight: 700; margin-bottom: 4px; }
.board-card-desc { font-size: .75rem; color: var(--text2); line-height: 1.4; }
.board-card-meta {
  font-size: .7rem; color: var(--text2);
  margin-top: 6px; display: flex; gap: 10px;
}
.board-card-arrow { color: var(--text2); align-self: center; font-size: 1.1rem; }

.board-empty-hint {
  text-align: center; padding: 32px 16px;
  color: var(--text2); font-size: .85rem; line-height: 1.8;
}
.board-empty-hint strong { color: var(--text); }

/* ============================================================
   ãƒ“ãƒ¥ãƒ¼â‘¤ ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§
   ============================================================ */
.board-view-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.new-thread-btn {
  display: flex; align-items: center; gap: 4px;
  padding: 8px 16px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff; border: none; border-radius: 50px;
  font-size: .8rem; font-weight: 600; cursor: pointer;
  transition: all .3s;
}
.new-thread-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(108,92,231,.4); }

/* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
.pagination {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  margin-top: 16px;
}
.pagination button {
  padding: 6px 14px;
  border: 1px solid var(--surface3); border-radius: 8px;
  background: var(--surface); color: var(--text2);
  font-size: .8rem; cursor: pointer; transition: all .2s;
}
.pagination button:hover:not(:disabled) { border-color: var(--accent); color: var(--text); }
.pagination button:disabled { opacity: .3; cursor: not-allowed; }
.pagination .page-info { font-size: .75rem; color: var(--text2); }

/* ============================================================
   ãƒ¢ãƒ¼ãƒ€ãƒ«: æ¿ã‚’ä½œæˆ
   ============================================================ */
.char-count { text-align: right; font-size: .7rem; color: var(--text2); margin-top: 4px; }
.form-error  { font-size: .8rem; color: var(--danger); margin-top: 8px; display: none; }
.form-error.show { display: block; }
</style>
</head>
<body>

<div class="page" id="page">
  <div class="container">

    <!-- ===== ãƒ“ãƒ¥ãƒ¼â‘  TOP ===== -->
    <div id="view-top" class="view active">
      <div style="text-align:center;padding:14px 0 6px">
        <div class="board-logo">Doppelganger</div>
        <div class="board-logo-sub">Community Board</div>
      </div>

      <!-- è‡ªåˆ†ã®ã‚¿ã‚¤ãƒ—ãƒãƒŠãƒ¼ -->
      <div class="my-type-banner" id="my-type-banner"></div>

      <!-- ãŠã™ã™ã‚ã®æ¿ï¼ˆè¶£å‘³ã«å¿œã˜ãŸãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºï¼‰ -->
      <div class="recommend-section" id="recommend-section" style="display:none">
        <div class="section-title">â­ ãŠã™ã™ã‚ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼</div>
        <div class="recommend-hint">ã‚ãªãŸã®è¶£å‘³è¨­å®šã«åŸºã¥ã„ã¦ã„ã¾ã™</div>
        <div class="recommend-chips" id="recommend-chips"></div>
      </div>

      <!-- ã‚¨ãƒªã‚¢é¸æŠ -->
      <div class="section-title" id="family-section-label"></div>
      <div class="area-cards" style="margin-bottom:24px">
        <!-- ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ©ã‚¦ãƒ³ã‚¸ -->
        <div class="area-card family-card" id="btn-family-area">
          <div class="area-card-icon" id="family-area-icon">ğŸ›ï¸</div>
          <div class="area-card-name" id="family-area-name">Family Lounge</div>
          <div class="area-card-desc">åŒã˜ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã®ä»²é–“ãŒé›†ã¾ã‚‹åºƒå ´</div>
        </div>
        <!-- åŒã‚¿ã‚¤ãƒ—ã®éƒ¨å±‹ -->
        <div class="area-card type-card" id="btn-type-area">
          <div class="area-card-icon" id="type-area-icon">ğŸ­</div>
          <div class="area-card-name" id="type-area-name">ã‚¿ã‚¤ãƒ—ã®éƒ¨å±‹</div>
          <div class="area-card-desc">å®Œå…¨ã«åŒã˜ã‚¿ã‚¤ãƒ—ã®äººã ã‘ã®å¯†ãªç©ºé–“</div>
        </div>
      </div>

      <!-- è¶£å‘³æœªè¨­å®šã®ãŠçŸ¥ã‚‰ã› -->
      <div id="hobby-setup-hint" style="display:none">
        <div class="recommend-section">
          <div class="section-title">ğŸŒŸ è¶£å‘³ã‚’è¨­å®šã—ã‚ˆã†</div>
          <div class="recommend-hint">è¶£å‘³ã‚’è¨­å®šã™ã‚‹ã¨ã€ãŠã™ã™ã‚ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
          <a href="profile.html?tab=hobby" class="btn btn-secondary btn-sm" style="display:inline-block;margin-top:4px">è¶£å‘³ã‚’è¨­å®šã™ã‚‹ â†’</a>
        </div>
      </div>
    </div>

    <!-- ===== ãƒ“ãƒ¥ãƒ¼â‘¡ å¤§ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ ===== -->
    <div id="view-categories" class="view">
      <div class="page-header">
        <button class="back-btn" id="back-from-categories">â†</button>
        <div>
          <div class="page-title" id="cat-view-title"></div>
          <div class="page-subtitle" id="cat-view-subtitle"></div>
        </div>
      </div>
      <div class="breadcrumb" id="breadcrumb-cat"></div>
      <div class="category-grid" id="category-grid"></div>
    </div>

    <!-- ===== ãƒ“ãƒ¥ãƒ¼â‘¢ ä¸­ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ ===== -->
    <div id="view-subcategories" class="view">
      <div class="page-header">
        <button class="back-btn" id="back-from-subcategories">â†</button>
        <div>
          <div class="page-title" id="subcat-view-title"></div>
          <div class="page-subtitle" id="subcat-view-subtitle"></div>
        </div>
      </div>
      <div class="breadcrumb" id="breadcrumb-subcat"></div>
      <div class="subcategory-list" id="subcategory-list"></div>
    </div>

    <!-- ===== ãƒ“ãƒ¥ãƒ¼â‘£ æ¿ä¸€è¦§ï¼ˆå°ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‰ ===== -->
    <div id="view-boards" class="view">
      <div class="page-header">
        <button class="back-btn" id="back-from-boards">â†</button>
        <div>
          <div class="page-title" id="boards-view-title"></div>
          <div class="page-subtitle" id="boards-view-subtitle"></div>
        </div>
      </div>
      <div class="breadcrumb" id="breadcrumb-boards"></div>

      <div class="board-list-header">
        <span style="font-size:.8rem;color:var(--text2)" id="boards-count-label"></span>
        <button class="new-board-btn" id="new-board-btn">ï¼‹ æ¿ã‚’ä½œã‚‹</button>
      </div>
      <div id="boards-list"></div>
    </div>

    <!-- ===== ãƒ“ãƒ¥ãƒ¼â‘¤ ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ ===== -->
    <div id="view-threads" class="view">
      <div class="page-header">
        <button class="back-btn" id="back-from-threads">â†</button>
        <div>
          <div class="page-title" id="threads-board-name"></div>
          <div class="page-subtitle" id="threads-board-desc"></div>
        </div>
      </div>
      <div class="breadcrumb" id="breadcrumb-threads"></div>

      <div class="board-view-header">
        <span style="font-size:.8rem;color:var(--text2)">ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</span>
        <button class="new-thread-btn" id="new-thread-btn">ï¼‹ ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç«‹ã¦ã‚‹</button>
      </div>
      <div id="threads-list"></div>
      <div class="pagination" id="pagination"></div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading hidden" id="loading">
      <div class="spinner"></div>
      <span>èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>

  </div><!-- /container -->
</div><!-- /page -->

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: æ¿ã‚’ä½œæˆ -->
<div class="modal-overlay" id="create-board-modal">
  <div class="modal">
    <div class="modal-title">æ–°ã—ã„æ¿ã‚’ä½œã‚‹</div>
    <p class="text-sm text-muted mb-16" id="create-board-hint" style="font-size:.8rem;color:var(--text2);margin-bottom:16px"></p>
    <div class="form-group">
      <label class="form-label">æ¿ã®ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input type="text" class="form-input" id="board-name-input"
             placeholder="ä¾‹: ãƒ•ã‚§ã‚¹å¥½ãé›†ã¾ã‚Œï¼" maxlength="40">
      <div class="char-count"><span id="board-name-count">0</span>/40</div>
    </div>
    <div class="form-group">
      <label class="form-label">èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
      <textarea class="form-input" id="board-desc-input"
                placeholder="ã“ã®æ¿ã«ã¤ã„ã¦ä¸€è¨€" maxlength="100" rows="2"></textarea>
      <div class="char-count"><span id="board-desc-count">0</span>/100</div>
    </div>
    <div class="form-group">
      <label class="form-label">ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—1æ–‡å­—ï¼‰</label>
      <input type="text" class="form-input" id="board-icon-input"
             placeholder="ä¾‹: ğŸ¸" maxlength="2" style="max-width:80px">
    </div>
    <div class="form-error" id="create-board-error"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary btn-sm" id="cancel-create-board">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary btn-sm" id="submit-create-board">ä½œæˆã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆ -->
<div class="modal-overlay" id="create-thread-modal">
  <div class="modal">
    <div class="modal-title">æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç«‹ã¦ã‚‹</div>
    <div class="form-group">
      <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input type="text" class="form-input" id="thread-title-input"
             placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¿ã‚¤ãƒˆãƒ«" maxlength="100">
      <div class="char-count"><span id="title-char-count">0</span>/100</div>
    </div>
    <div class="form-group">
      <label class="form-label">æœ¬æ–‡</label>
      <textarea class="form-input" id="thread-content-input"
                placeholder="æœ€åˆã®æŠ•ç¨¿ã‚’æ›¸ã„ã¦ãã ã•ã„" maxlength="2000" rows="5"></textarea>
      <div class="char-count"><span id="content-char-count">0</span>/2000</div>
    </div>
    <div class="form-error" id="create-thread-error"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary btn-sm" id="cancel-create-thread">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary btn-sm" id="submit-create-thread">ä½œæˆã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<nav class="nav-bar">
  <a href="board.html" class="nav-item active">
    <span class="nav-icon">ğŸ’¬</span>
    <span>æ²ç¤ºæ¿</span>
  </a>
  <a href="matching.html" class="nav-item">
    <span class="nav-icon">ğŸ’•</span>
    <span>ãƒãƒƒãƒãƒ³ã‚°</span>
  </a>
  <a href="profile.html" class="nav-item">
    <span class="nav-icon" id="nav-my-avatar">ğŸ‘¤</span>
    <span id="nav-my-name">ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
  </a>
</nav>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="js/supabase-config.js"></script>
<script src="js/auth.js"></script>
<script src="js/moderation.js"></script>
<script src="js/board.js"></script>
<script>
(function () {
  // ================================================================
  // çŠ¶æ…‹ç®¡ç†
  // ================================================================
  let myProfile = null;
  let currentAreaType   = null;  // 'family' | 'type'
  let currentCategoryId  = null;
  let currentSubcatId    = null;
  let currentBoardId     = null;
  let currentBoardName   = '';
  let currentBoardDesc   = '';
  let currentPage        = 1;
  const THREADS_PER_PAGE = 20;

  // ================================================================
  // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
  // ================================================================
  function showView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0, 0);
  }

  // ================================================================
  // åˆæœŸåŒ–
  // ================================================================
  async function init() {
    showLoading(true);
    try {
      const user = await requireAuth();
      if (!user) return;
      myProfile = await requireDiagnosis();
      if (!myProfile) return;

      initNavUser();
      renderTopView();
      showView('view-top');
    } catch (err) {
      showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // ================================================================
  // ãƒ“ãƒ¥ãƒ¼â‘  TOP
  // ================================================================
  function renderTopView() {
    const fam = myProfile.family || 'Architects';
    const familyIcons = { Architects:'ğŸ›ï¸', Mystics:'ğŸŒ™', Commanders:'âš”ï¸', Catalysts:'ğŸ”¥' };
    const familyDescs = {
      Architects: 'åˆ†æãƒ»è«–ç†ãƒ»æ§‹é€ ã‚’æ„›ã™ã‚‹è€…ãŸã¡ã®åºƒå ´',
      Mystics:    'æ„Ÿæ€§ãƒ»æ²¡å…¥ãƒ»ä¸–ç•Œè¦³ã‚’å…±æœ‰ã™ã‚‹è€…ãŸã¡ã®åºƒå ´',
      Commanders: 'ä¼ç”»ãƒ»æ”»ç•¥ãƒ»æƒ…å ±æ•´ç†ã§æ¥½ã—ã‚€è€…ãŸã¡ã®åºƒå ´',
      Catalysts:  'ä½“é¨“ãƒ»å…±æœ‰ãƒ»ç››ã‚Šä¸ŠãŒã‚Šã‚’æ„›ã™ã‚‹è€…ãŸã¡ã®åºƒå ´',
    };
    const colorVar = familyColor(fam);

    // ã‚¿ã‚¤ãƒ—ãƒãƒŠãƒ¼
    document.getElementById('my-type-banner').innerHTML = `
      <div class="my-type-icon"
           style="background:rgba(${_familyColorRGB(fam)},.12);border:1px solid rgba(${_familyColorRGB(fam)},.3)">
        ${getTypeEmoji(myProfile.type_number)}
      </div>
      <div class="my-type-info">
        <div class="my-type-name">Type ${myProfile.type_number}: ${escapeHtml(myProfile.type_name || '')}</div>
        <div class="my-type-sub">${fam} Family ãƒ» ${escapeHtml(myProfile.display_id || '')}</div>
      </div>
      <span class="badge badge-${fam.toLowerCase()}">${fam}</span>
    `;

    // ã‚¨ãƒªã‚¢ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ï¼‰
    document.getElementById('family-area-icon').textContent = familyIcons[fam] || 'ğŸ›ï¸';
    document.getElementById('family-area-name').textContent = fam + ' Lounge';
    document.querySelector('#btn-family-area .area-card-desc').textContent = familyDescs[fam] || 'åŒã˜ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã®ä»²é–“ãŒé›†ã¾ã‚‹åºƒå ´';
    document.getElementById('family-section-label').textContent = 'ğŸšª ã©ã®ã‚¨ãƒªã‚¢ã«å…¥ã‚‹ï¼Ÿ';

    // ã‚¨ãƒªã‚¢ã‚«ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚¤ãƒ—ï¼‰
    document.getElementById('type-area-icon').textContent = getTypeEmoji(myProfile.type_number);
    document.getElementById('type-area-name').textContent = 'Type ' + myProfile.type_number + 'ã®éƒ¨å±‹';

    // ãŠã™ã™ã‚ï¼ˆè¶£å‘³è¨­å®šæ¸ˆã¿ã®å ´åˆï¼‰
    const hobbies = myProfile.hobbies || [];
    if (hobbies.length > 0) {
      renderRecommendChips(hobbies);
      document.getElementById('recommend-section').style.display = 'block';
    } else {
      document.getElementById('hobby-setup-hint').style.display = 'block';
    }
  }

  function renderRecommendChips(hobbyCategoryIds) {
    const chips = document.getElementById('recommend-chips');
    const catData = Board.getCategoryData();
    chips.innerHTML = hobbyCategoryIds.map(id => {
      const cat = catData.find(c => c.id === id);
      if (!cat) return '';
      return `
        <span class="recommend-chip" data-cat-id="${id}">
          ${cat.icon} ${cat.name}
        </span>
      `;
    }).join('');

    chips.querySelectorAll('.recommend-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const catId = parseInt(chip.dataset.catId);
        enterCategoryView(catId);
      });
    });
  }

  // ================================================================
  // ã‚¨ãƒªã‚¢é¸æŠ â†’ ãƒ“ãƒ¥ãƒ¼â‘¡ï¼ˆå¤§ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‰
  // ================================================================
  document.getElementById('btn-family-area').addEventListener('click', () => {
    currentAreaType = 'family';
    enterCategoryView(null);
  });
  document.getElementById('btn-type-area').addEventListener('click', () => {
    currentAreaType = 'type';
    enterCategoryView(null);
  });

  function enterCategoryView(preselectedCatId) {
    const fam = myProfile.family || 'Architects';
    const areaLabel = currentAreaType === 'family'
      ? fam + ' Lounge'
      : 'Type ' + myProfile.type_number + 'ã®éƒ¨å±‹';

    document.getElementById('cat-view-title').textContent = areaLabel;
    document.getElementById('cat-view-subtitle').textContent = 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„';

    // ãƒ‘ãƒ³ããš
    document.getElementById('breadcrumb-cat').innerHTML = `
      <span class="breadcrumb-item" id="bc-top-cat">TOP</span>
      <span class="breadcrumb-sep">â€º</span>
      <span class="breadcrumb-current">${escapeHtml(areaLabel)}</span>
    `;
    document.getElementById('bc-top-cat').addEventListener('click', () => showView('view-top'));

    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    const catData = Board.getCategoryData();
    document.getElementById('category-grid').innerHTML = catData.map(cat => `
      <div class="category-card" data-cat-id="${cat.id}">
        <span class="category-icon">${cat.icon}</span>
        <span class="category-name">${escapeHtml(cat.name)}</span>
      </div>
    `).join('');

    document.querySelectorAll('.category-card').forEach(card => {
      card.addEventListener('click', () => {
        enterSubcategoryView(parseInt(card.dataset.catId));
      });
    });

    showView('view-categories');

    // ãŠã™ã™ã‚ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‹ã‚‰æ¥ãŸå ´åˆã¯ç›´æ¥ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¸
    if (preselectedCatId !== null) {
      enterSubcategoryView(preselectedCatId);
    }
  }

  // ================================================================
  // ãƒ“ãƒ¥ãƒ¼â‘¢ ä¸­ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‰
  // ================================================================
  async function enterSubcategoryView(catId) {
    showLoading(true);
    try {
      currentCategoryId = catId;
      const catData = Board.getCategoryData();
      const cat = catData.find(c => c.id === catId);
      const fam = myProfile.family || 'Architects';
      const areaLabel = currentAreaType === 'family'
        ? fam + ' Lounge'
        : 'Type ' + myProfile.type_number + 'ã®éƒ¨å±‹';

      document.getElementById('subcat-view-title').textContent = cat ? cat.icon + ' ' + cat.name : 'ã‚«ãƒ†ã‚´ãƒªãƒ¼';
      document.getElementById('subcat-view-subtitle').textContent = 'æ¿ãŒå…¥ã£ã¦ã„ã‚‹ä¸­ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„';

      document.getElementById('breadcrumb-subcat').innerHTML = `
        <span class="breadcrumb-item" id="bc-top-sub">TOP</span>
        <span class="breadcrumb-sep">â€º</span>
        <span class="breadcrumb-item" id="bc-area-sub">${escapeHtml(areaLabel)}</span>
        <span class="breadcrumb-sep">â€º</span>
        <span class="breadcrumb-current">${cat ? escapeHtml(cat.name) : ''}</span>
      `;
      document.getElementById('bc-top-sub').addEventListener('click', () => showView('view-top'));
      document.getElementById('bc-area-sub').addEventListener('click', () => showView('view-categories'));

      // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼å–å¾—
      const subcats = await Board.getSubcategories(catId);

      if (subcats.length === 0) {
        document.getElementById('subcategory-list').innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“‚</div>
            <div class="empty-text">ä¸­ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        `;
      } else {
        document.getElementById('subcategory-list').innerHTML = subcats.map(sub => `
          <div class="subcategory-row" data-subcat-id="${sub.id}" data-subcat-name="${escapeHtml(sub.name)}">
            <span class="subcategory-icon">${sub.icon || 'ğŸ“‹'}</span>
            <span class="subcategory-name">${escapeHtml(sub.name)}</span>
            <span class="subcategory-arrow">â€º</span>
          </div>
        `).join('');

        document.querySelectorAll('.subcategory-row').forEach(row => {
          row.addEventListener('click', () => {
            enterBoardsView(parseInt(row.dataset.subcatId), row.dataset.subcatName);
          });
        });
      }

      showView('view-subcategories');
    } catch (err) {
      showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    } finally {
      showLoading(false);
    }
  }

  // ================================================================
  // ãƒ“ãƒ¥ãƒ¼â‘£ æ¿ä¸€è¦§ï¼ˆå°ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‰
  // ================================================================
  async function enterBoardsView(subcatId, subcatName) {
    showLoading(true);
    try {
      currentSubcatId = subcatId;
      const catData = Board.getCategoryData();
      const cat = catData.find(c => c.id === currentCategoryId);
      const fam = myProfile.family || 'Architects';
      const areaLabel = currentAreaType === 'family'
        ? fam + ' Lounge'
        : 'Type ' + myProfile.type_number + 'ã®éƒ¨å±‹';

      document.getElementById('boards-view-title').textContent = subcatName;
      document.getElementById('boards-view-subtitle').textContent = 'æ¿ã‚’é¸ã‚“ã§ãã ã•ã„';

      document.getElementById('breadcrumb-boards').innerHTML = `
        <span class="breadcrumb-item" id="bc-top-b">TOP</span>
        <span class="breadcrumb-sep">â€º</span>
        <span class="breadcrumb-item" id="bc-area-b">${escapeHtml(areaLabel)}</span>
        <span class="breadcrumb-sep">â€º</span>
        <span class="breadcrumb-item" id="bc-cat-b">${cat ? escapeHtml(cat.name) : ''}</span>
        <span class="breadcrumb-sep">â€º</span>
        <span class="breadcrumb-current">${escapeHtml(subcatName)}</span>
      `;
      document.getElementById('bc-top-b').addEventListener('click', () => showView('view-top'));
      document.getElementById('bc-area-b').addEventListener('click', () => showView('view-categories'));
      document.getElementById('bc-cat-b').addEventListener('click', () => showView('view-subcategories'));

      // æ¿ä¸€è¦§å–å¾—ï¼ˆã“ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ + ã“ã®ã‚¨ãƒªã‚¢ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
      const boards = await Board.getBoardsBySubcategory(subcatId, currentAreaType, myProfile);

      document.getElementById('boards-count-label').textContent = `${boards.length}ä»¶ã®æ¿`;

      if (boards.length === 0) {
        document.getElementById('boards-list').innerHTML = `
          <div class="board-empty-hint">
            <div style="font-size:2rem;margin-bottom:8px">ğŸ“Œ</div>
            ã¾ã æ¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
            <strong>ã€Œæ¿ã‚’ä½œã‚‹ã€</strong>ã‹ã‚‰æœ€åˆã®æ¿ã‚’ç«‹ã¡ä¸Šã’ã¾ã—ã‚‡ã†ï¼
          </div>
        `;
      } else {
        document.getElementById('boards-list').innerHTML = boards.map(b => `
          <div class="board-card-item" data-board-id="${b.id}">
            <span class="board-card-icon">${b.icon || 'ğŸ“‹'}</span>
            <div class="board-card-body">
              <div class="board-card-name">${escapeHtml(b.name)}</div>
              <div class="board-card-desc">${escapeHtml(b.description || '')}</div>
              <div class="board-card-meta">
                <span>ğŸ§µ ã‚¹ãƒ¬ãƒƒãƒ‰: ${b.thread_count || 0}</span>
                <span>ğŸ’¬ æŠ•ç¨¿: ${b.post_count || 0}</span>
              </div>
            </div>
            <span class="board-card-arrow">â€º</span>
          </div>
        `).join('');

        document.querySelectorAll('.board-card-item').forEach(card => {
          card.addEventListener('click', () => {
            enterThreadsView(card.dataset.boardId);
          });
        });
      }

      // æ¿ä½œæˆãƒœã‚¿ãƒ³ã®ãƒ’ãƒ³ãƒˆæ›´æ–°
      document.getElementById('create-board-hint').textContent =
        `ã€Œ${subcatName}ã€ã®ä¸­ã«æ¿ã‚’ä½œã‚Šã¾ã™ï¼ˆ${areaLabel}ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿é–²è¦§å¯èƒ½ï¼‰`;

      showView('view-boards');
    } catch (err) {
      showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    } finally {
      showLoading(false);
    }
  }

  // ================================================================
  // ãƒ“ãƒ¥ãƒ¼â‘¤ ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§
  // ================================================================
  async function enterThreadsView(boardId) {
    showLoading(true);
    try {
      currentBoardId = boardId;
      currentPage    = 1;

      const board = await Board.getBoard(boardId);
      currentBoardName = board.name;
      currentBoardDesc = board.description || '';

      document.getElementById('threads-board-name').textContent = currentBoardName;
      document.getElementById('threads-board-desc').textContent = currentBoardDesc;

      // ãƒ‘ãƒ³ããšï¼ˆç°¡ç•¥ç‰ˆï¼‰
      document.getElementById('breadcrumb-threads').innerHTML = `
        <span class="breadcrumb-item" id="bc-top-t">TOP</span>
        <span class="breadcrumb-sep">â€º</span>
        <span class="breadcrumb-item" id="bc-boards-t">æ¿ä¸€è¦§</span>
        <span class="breadcrumb-sep">â€º</span>
        <span class="breadcrumb-current">${escapeHtml(currentBoardName)}</span>
      `;
      document.getElementById('bc-top-t').addEventListener('click', () => showView('view-top'));
      document.getElementById('bc-boards-t').addEventListener('click', () => showView('view-boards'));

      await loadThreads();
      showView('view-threads');
    } catch (err) {
      showToast('æ¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    } finally {
      showLoading(false);
    }
  }

  async function loadThreads() {
    const list = document.getElementById('threads-list');
    list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

    try {
      const { threads, total } = await Board.getThreads(currentBoardId, {
        page: currentPage, limit: THREADS_PER_PAGE,
      });

      if (threads.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ’­</div>
            <div class="empty-text">ã¾ã ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>æœ€åˆã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç«‹ã¦ã¾ã—ã‚‡ã†ï¼</div>
          </div>
        `;
      } else {
        list.innerHTML = threads.map(t => Board.renderThreadItem(t)).join('');
      }
      renderPagination(total);
    } catch (err) {
      list.innerHTML = '<div class="empty-state"><div class="empty-text">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div></div>';
    }
  }

  function renderPagination(total) {
    const totalPages = Math.ceil(total / THREADS_PER_PAGE);
    const pag = document.getElementById('pagination');
    if (totalPages <= 1) { pag.innerHTML = ''; return; }

    pag.innerHTML = `
      <button id="prev-page" ${currentPage <= 1 ? 'disabled' : ''}>â€¹ å‰</button>
      <span class="page-info">${currentPage} / ${totalPages}</span>
      <button id="next-page" ${currentPage >= totalPages ? 'disabled' : ''}>æ¬¡ â€º</button>
    `;
    document.getElementById('prev-page')?.addEventListener('click', () => {
      if (currentPage > 1) { currentPage--; loadThreads(); }
    });
    document.getElementById('next-page')?.addEventListener('click', () => {
      if (currentPage < totalPages) { currentPage++; loadThreads(); }
    });
  }

  // ================================================================
  // æˆ»ã‚‹ãƒœã‚¿ãƒ³
  // ================================================================
  document.getElementById('back-from-categories').addEventListener('click', () => showView('view-top'));
  document.getElementById('back-from-subcategories').addEventListener('click', () => showView('view-categories'));
  document.getElementById('back-from-boards').addEventListener('click', () => showView('view-subcategories'));
  document.getElementById('back-from-threads').addEventListener('click', () => showView('view-boards'));

  // ================================================================
  // æ¿ã‚’ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«
  // ================================================================
  const createBoardModal = document.getElementById('create-board-modal');
  const boardNameInput   = document.getElementById('board-name-input');
  const boardDescInput   = document.getElementById('board-desc-input');
  const boardIconInput   = document.getElementById('board-icon-input');

  document.getElementById('new-board-btn').addEventListener('click', () => {
    boardNameInput.value = '';
    boardDescInput.value = '';
    boardIconInput.value = '';
    document.getElementById('board-name-count').textContent = '0';
    document.getElementById('board-desc-count').textContent = '0';
    document.getElementById('create-board-error').classList.remove('show');
    createBoardModal.classList.add('show');
  });
  document.getElementById('cancel-create-board').addEventListener('click', () => {
    createBoardModal.classList.remove('show');
  });
  createBoardModal.addEventListener('click', e => {
    if (e.target === createBoardModal) createBoardModal.classList.remove('show');
  });
  boardNameInput.addEventListener('input', () => {
    document.getElementById('board-name-count').textContent = boardNameInput.value.length;
  });
  boardDescInput.addEventListener('input', () => {
    document.getElementById('board-desc-count').textContent = boardDescInput.value.length;
  });

  document.getElementById('submit-create-board').addEventListener('click', async () => {
    const errorEl  = document.getElementById('create-board-error');
    const submitBtn = document.getElementById('submit-create-board');
    errorEl.classList.remove('show');

    const name = boardNameInput.value.trim();
    const desc = boardDescInput.value.trim();
    const icon = boardIconInput.value.trim() || 'ğŸ“‹';

    if (!name) {
      errorEl.textContent = 'æ¿ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      errorEl.classList.add('show');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'ä½œæˆä¸­...';

    try {
      await Board.createBoard({
        subcategoryId: currentSubcatId,
        areaType: currentAreaType,
        profile: myProfile,
        name, desc, icon,
      });
      createBoardModal.classList.remove('show');
      showToast('æ¿ã‚’ä½œæˆã—ã¾ã—ãŸï¼', 'success');
      await enterBoardsView(currentSubcatId, document.getElementById('boards-view-title').textContent);
    } catch (err) {
      errorEl.textContent = err.message;
      errorEl.classList.add('show');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'ä½œæˆã™ã‚‹';
    }
  });

  // ================================================================
  // ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«
  // ================================================================
  const createThreadModal = document.getElementById('create-thread-modal');
  const titleInput        = document.getElementById('thread-title-input');
  const contentInput      = document.getElementById('thread-content-input');

  document.getElementById('new-thread-btn').addEventListener('click', () => {
    titleInput.value = '';
    contentInput.value = '';
    document.getElementById('title-char-count').textContent = '0';
    document.getElementById('content-char-count').textContent = '0';
    document.getElementById('create-thread-error').classList.remove('show');
    createThreadModal.classList.add('show');
  });
  document.getElementById('cancel-create-thread').addEventListener('click', () => {
    createThreadModal.classList.remove('show');
  });
  createThreadModal.addEventListener('click', e => {
    if (e.target === createThreadModal) createThreadModal.classList.remove('show');
  });

  titleInput.addEventListener('input', () => {
    document.getElementById('title-char-count').textContent = titleInput.value.length;
  });
  contentInput.addEventListener('input', () => {
    document.getElementById('content-char-count').textContent = contentInput.value.length;
  });

  document.getElementById('submit-create-thread').addEventListener('click', async () => {
    const errorEl  = document.getElementById('create-thread-error');
    const submitBtn = document.getElementById('submit-create-thread');
    errorEl.classList.remove('show');

    const title   = titleInput.value.trim();
    const content = contentInput.value.trim();

    if (!title || !content) {
      errorEl.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      errorEl.classList.add('show');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'ä½œæˆä¸­...';

    try {
      const thread = await Board.createThread(currentBoardId, title, content);
      createThreadModal.classList.remove('show');
      showToast('ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸï¼', 'success');
      window.location.href = `thread.html?id=${thread.id}`;
    } catch (err) {
      errorEl.textContent = err.message;
      errorEl.classList.add('show');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'ä½œæˆã™ã‚‹';
    }
  });

  // ================================================================
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
  // ================================================================
  function showLoading(show) {
    document.getElementById('loading').classList.toggle('hidden', !show);
  }

  // ================================================================
  // èµ·å‹•
  // ================================================================
  init();
})();
</script>
</body>
</html>
