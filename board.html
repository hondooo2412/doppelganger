<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Doppelganger - æ²ç¤ºæ¿</title>
<link rel="stylesheet" href="css/common.css">
<style>
  .board-top-header{
    text-align:center;padding:16px 0 8px;animation:fadeIn .5s ease;
  }
  .board-top-logo{
    font-size:1.4rem;font-weight:900;
    background:linear-gradient(135deg,#6c5ce7,#a29bfe,#fd79a8);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    margin-bottom:4px;
  }
  .board-top-sub{font-size:.72rem;color:var(--text2);letter-spacing:.15em}

  .my-type-banner{
    display:flex;align-items:center;gap:12px;
    padding:14px 16px;margin:16px 0;
    background:var(--surface);border:1px solid var(--surface3);
    border-radius:var(--radius);
  }
  .my-type-icon{
    width:42px;height:42px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    font-size:1.3rem;flex-shrink:0;
  }
  .my-type-info{flex:1}
  .my-type-name{font-size:.9rem;font-weight:700}
  .my-type-sub{font-size:.72rem;color:var(--text2);margin-top:2px}

  /* ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ãƒ“ãƒ¥ãƒ¼ */
  .board-view-header{
    display:flex;align-items:center;justify-content:space-between;
    margin-bottom:14px;
  }
  .board-view-title{display:flex;align-items:center;gap:8px}
  .board-view-icon{font-size:1.4rem}
  .board-view-name{font-size:1rem;font-weight:700}

  .new-thread-btn{
    display:flex;align-items:center;gap:4px;
    padding:8px 16px;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    color:#fff;border:none;border-radius:50px;
    font-size:.8rem;font-weight:600;cursor:pointer;
    transition:all .3s;
  }
  .new-thread-btn:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(108,92,231,.4)}

  /* æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« */
  .create-thread-form{margin-top:8px}
  .char-count{text-align:right;font-size:.7rem;color:var(--text2);margin-top:4px}

  /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
  .pagination{
    display:flex;align-items:center;justify-content:center;gap:8px;
    margin-top:16px;
  }
  .pagination button{
    padding:6px 14px;
    border:1px solid var(--surface3);border-radius:8px;
    background:var(--surface);color:var(--text2);
    font-size:.8rem;cursor:pointer;transition:all .2s;
  }
  .pagination button:hover:not(:disabled){border-color:var(--accent);color:var(--text)}
  .pagination button:disabled{opacity:.3;cursor:not-allowed}
  .pagination .page-info{font-size:.75rem;color:var(--text2)}
</style>
</head>
<body>

<div class="page" id="page">
  <div class="container">

    <!-- ===== ãƒˆãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼: æ¿ä¸€è¦§ ===== -->
    <div id="boards-view">
      <div class="board-top-header">
        <div class="board-top-logo">Doppelganger</div>
        <div class="board-top-sub">Community Board</div>
      </div>

      <!-- è‡ªåˆ†ã®ã‚¿ã‚¤ãƒ—è¡¨ç¤º -->
      <div class="my-type-banner" id="my-type-banner"></div>

      <!-- ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ©ã‚¦ãƒ³ã‚¸ -->
      <div class="section-title" id="family-section-title"></div>
      <div id="family-boards"></div>

      <!-- ã‚¿ã‚¤ãƒ—åˆ¥ãƒ«ãƒ¼ãƒ  -->
      <div class="section-title mt-24">ã‚ãªãŸã®ã‚¿ã‚¤ãƒ—ã®éƒ¨å±‹</div>
      <div id="type-boards"></div>
    </div>

    <!-- ===== ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ãƒ“ãƒ¥ãƒ¼ ===== -->
    <div id="threads-view" class="hidden">
      <div class="page-header">
        <button class="back-btn" id="back-to-boards">â†</button>
        <div>
          <div class="page-title" id="current-board-name"></div>
          <div class="page-subtitle" id="current-board-desc"></div>
        </div>
      </div>

      <div class="board-view-header">
        <div class="board-view-title">
          <span class="board-view-icon" id="board-view-icon"></span>
          <span class="board-view-name">ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</span>
        </div>
        <button class="new-thread-btn" id="new-thread-btn">ï¼‹ æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰</button>
      </div>

      <div id="threads-list"></div>

      <div class="pagination" id="pagination"></div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading hidden" id="loading">
      <div class="spinner"></div>
      <span>èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
  </div>
</div>

<!-- æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="create-thread-modal">
  <div class="modal">
    <div class="modal-title">æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆ</div>
    <div class="create-thread-form">
      <div class="form-group">
        <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
        <input type="text" class="form-input" id="thread-title-input"
               placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¿ã‚¤ãƒˆãƒ«" maxlength="100">
        <div class="char-count"><span id="title-char-count">0</span>/100</div>
      </div>
      <div class="form-group">
        <label class="form-label">æœ¬æ–‡</label>
        <textarea class="form-input" id="thread-content-input"
                  placeholder="æœ€åˆã®æŠ•ç¨¿ã‚’æ›¸ã„ã¦ãã ã•ã„" maxlength="2000" rows="5"></textarea>
        <div class="char-count"><span id="content-char-count">0</span>/2000</div>
      </div>
      <div class="form-error" id="create-thread-error"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary btn-sm" id="cancel-create-thread">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary btn-sm" id="submit-create-thread">ä½œæˆã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<nav class="nav-bar">
  <a href="board.html" class="nav-item active">
    <span class="nav-icon">ğŸ’¬</span>
    <span>æ²ç¤ºæ¿</span>
  </a>
  <a href="doppelganger-diagnosis.index.html" class="nav-item">
    <span class="nav-icon">ğŸ”®</span>
    <span>è¨ºæ–­</span>
  </a>
  <a href="profile.html" class="nav-item">
    <span class="nav-icon">ğŸ‘¤</span>
    <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
  </a>
</nav>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="js/supabase-config.js"></script>
<script src="js/auth.js"></script>
<script src="js/moderation.js"></script>
<script src="js/board.js"></script>
<script>
(function() {
  let currentBoardId = null;
  let currentPage = 1;
  const THREADS_PER_PAGE = 20;

  // --- åˆæœŸåŒ– ---
  async function init() {
    showLoading(true);
    try {
      const user = await requireAuth();
      if (!user) return;

      const profile = await requireDiagnosis();
      if (!profile) return;

      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¿æŒ‡å®šãŒã‚ã‚‹å ´åˆ
      const params = new URLSearchParams(window.location.search);
      const boardId = params.get('id');

      // è‡ªåˆ†ã®ã‚¿ã‚¤ãƒ—è¡¨ç¤º
      renderMyTypeBanner(profile);

      if (boardId) {
        await showThreadsView(boardId);
      } else {
        await showBoardsView();
      }
    } catch (err) {
      showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // --- è‡ªåˆ†ã®ã‚¿ã‚¤ãƒ—ãƒãƒŠãƒ¼ ---
  function renderMyTypeBanner(profile) {
    const fam = profile.family || 'Architects';
    const colorVar = familyColor(fam);
    document.getElementById('my-type-banner').innerHTML = `
      <div class="my-type-icon" style="background:rgba(${colorVar},.12);border:1px solid rgba(${colorVar},.3)">
        ${getTypeEmoji(profile.type_number)}
      </div>
      <div class="my-type-info">
        <div class="my-type-name">Type ${profile.type_number}: ${escapeHtml(profile.type_name || '')}</div>
        <div class="my-type-sub">${fam} Family ãƒ» ${escapeHtml(profile.display_id || '')}</div>
      </div>
      <span class="badge badge-${fam.toLowerCase()}">${fam}</span>
    `;

    // ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
    const familyNames = {
      Architects: 'ğŸ›ï¸ Architects Lounge',
      Mystics: 'ğŸŒ™ Mystics Lounge',
      Commanders: 'âš”ï¸ Commanders Lounge',
      Catalysts: 'ğŸ”¥ Catalysts Lounge',
    };
    document.getElementById('family-section-title').textContent =
      familyNames[fam] || 'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ©ã‚¦ãƒ³ã‚¸';
  }

  // --- æ¿ä¸€è¦§è¡¨ç¤º ---
  async function showBoardsView() {
    document.getElementById('boards-view').classList.remove('hidden');
    document.getElementById('threads-view').classList.add('hidden');

    const boards = await Board.getBoards();
    const familyBoards = boards.filter(b => b.board_type === 'family');
    const typeBoards = boards.filter(b => b.board_type === 'type');

    document.getElementById('family-boards').innerHTML =
      familyBoards.map(b => Board.renderBoardCard(b)).join('') ||
      '<div class="empty-state"><div class="empty-text">ãƒ©ã‚¦ãƒ³ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div></div>';

    document.getElementById('type-boards').innerHTML =
      typeBoards.map(b => Board.renderBoardCard(b)).join('') ||
      '<div class="empty-state"><div class="empty-text">ã‚¿ã‚¤ãƒ—åˆ¥ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div></div>';

    // æ¿ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.board-card').forEach(card => {
      card.addEventListener('click', (e) => {
        e.preventDefault();
        const boardId = card.dataset.boardId;
        history.pushState({ boardId }, '', `board.html?id=${boardId}`);
        showThreadsView(boardId);
      });
    });

    // URLæ›´æ–°
    history.replaceState({}, '', 'board.html');
  }

  // --- ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§è¡¨ç¤º ---
  async function showThreadsView(boardId) {
    currentBoardId = boardId;
    currentPage = 1;

    document.getElementById('boards-view').classList.add('hidden');
    document.getElementById('threads-view').classList.remove('hidden');
    showLoading(true);

    try {
      const board = await Board.getBoard(boardId);
      document.getElementById('current-board-name').textContent = board.name;
      document.getElementById('current-board-desc').textContent = board.description || '';
      document.getElementById('board-view-icon').textContent = board.icon || 'ğŸ“‹';

      await loadThreads();
    } catch (err) {
      showToast('æ¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    } finally {
      showLoading(false);
    }
  }

  // --- ã‚¹ãƒ¬ãƒƒãƒ‰èª­ã¿è¾¼ã¿ ---
  async function loadThreads() {
    const list = document.getElementById('threads-list');
    list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

    try {
      const { threads, total } = await Board.getThreads(currentBoardId, {
        page: currentPage,
        limit: THREADS_PER_PAGE,
      });

      if (threads.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ’­</div>
            <div class="empty-text">ã¾ã ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>æœ€åˆã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ï¼</div>
          </div>
        `;
      } else {
        list.innerHTML = threads.map(t => Board.renderThreadItem(t)).join('');
      }

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
      renderPagination(total);
    } catch (err) {
      list.innerHTML = '<div class="empty-state"><div class="empty-text">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div></div>';
    }
  }

  // --- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ ---
  function renderPagination(total) {
    const totalPages = Math.ceil(total / THREADS_PER_PAGE);
    const pag = document.getElementById('pagination');

    if (totalPages <= 1) {
      pag.innerHTML = '';
      return;
    }

    pag.innerHTML = `
      <button id="prev-page" ${currentPage <= 1 ? 'disabled' : ''}>â€¹ å‰</button>
      <span class="page-info">${currentPage} / ${totalPages}</span>
      <button id="next-page" ${currentPage >= totalPages ? 'disabled' : ''}>æ¬¡ â€º</button>
    `;

    document.getElementById('prev-page')?.addEventListener('click', () => {
      if (currentPage > 1) { currentPage--; loadThreads(); }
    });
    document.getElementById('next-page')?.addEventListener('click', () => {
      if (currentPage < totalPages) { currentPage++; loadThreads(); }
    });
  }

  // --- æˆ»ã‚‹ãƒœã‚¿ãƒ³ ---
  document.getElementById('back-to-boards').addEventListener('click', () => {
    showBoardsView();
  });

  // --- ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€å¯¾å¿œ ---
  window.addEventListener('popstate', (e) => {
    if (e.state && e.state.boardId) {
      showThreadsView(e.state.boardId);
    } else {
      showBoardsView();
    }
  });

  // --- æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ ---
  const createModal = document.getElementById('create-thread-modal');
  const titleInput = document.getElementById('thread-title-input');
  const contentInput = document.getElementById('thread-content-input');

  document.getElementById('new-thread-btn').addEventListener('click', () => {
    titleInput.value = '';
    contentInput.value = '';
    document.getElementById('title-char-count').textContent = '0';
    document.getElementById('content-char-count').textContent = '0';
    document.getElementById('create-thread-error').classList.remove('show');
    createModal.classList.add('show');
  });

  document.getElementById('cancel-create-thread').addEventListener('click', () => {
    createModal.classList.remove('show');
  });

  createModal.addEventListener('click', (e) => {
    if (e.target === createModal) createModal.classList.remove('show');
  });

  // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
  titleInput.addEventListener('input', () => {
    document.getElementById('title-char-count').textContent = titleInput.value.length;
  });
  contentInput.addEventListener('input', () => {
    document.getElementById('content-char-count').textContent = contentInput.value.length;
  });

  // é€ä¿¡
  document.getElementById('submit-create-thread').addEventListener('click', async () => {
    const errorEl = document.getElementById('create-thread-error');
    const submitBtn = document.getElementById('submit-create-thread');
    errorEl.classList.remove('show');

    const title = titleInput.value.trim();
    const content = contentInput.value.trim();

    if (!title || !content) {
      errorEl.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      errorEl.classList.add('show');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'ä½œæˆä¸­...';

    try {
      const thread = await Board.createThread(currentBoardId, title, content);
      createModal.classList.remove('show');
      showToast('ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸï¼', 'success');
      // ä½œæˆã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã«é·ç§»
      window.location.href = `thread.html?id=${thread.id}`;
    } catch (err) {
      errorEl.textContent = err.message;
      errorEl.classList.add('show');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'ä½œæˆã™ã‚‹';
    }
  });

  // --- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º ---
  function showLoading(show) {
    document.getElementById('loading').classList.toggle('hidden', !show);
  }

  // --- èµ·å‹• ---
  init();
})();
</script>
</body>
</html>
